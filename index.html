<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Journal Pro</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #000000;
            --secondary: #FFFFFF;
            --accent-green: #00D878;
            --accent-red: #FF375F;
            --accent-blue: #007AFF;
            --accent-orange: #FF9500;
            --accent-purple: #BF5AF2;
            
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F9FA;
            --bg-card: #FFFFFF;
            --bg-header: #FFFFFF;
            
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --text-muted: #C7C7CC;
            
            --border: #E5E5EA;
            --shadow: 0 2px 16px rgba(0,0,0,0.08);
            
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        [data-theme="dark"] {
            --primary: #FFFFFF;
            --secondary: #000000;
            --accent-green: #00D878;
            --accent-red: #FF375F;
            --accent-blue: #0A84FF;
            --accent-orange: #FF9F0A;
            --accent-purple: #BF5AF2;
            
            --bg-primary: #000000;
            --bg-secondary: #1C1C1E;
            --bg-card: #1C1C1E;
            --bg-header: #000000;
            
            --text-primary: #FFFFFF;
            --text-secondary: #98989F;
            --text-muted: #48484A;
            
            --border: #38383A;
            --shadow: 0 2px 16px rgba(0,0,0,0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        /* Header */
        .header {
            position: fixed;
            top: var(--safe-area-top);
            left: 0;
            right: 0;
            background: var(--bg-header);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            z-index: 1000;
            display: none;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(20px);
        }

        .header-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .icon-btn:active {
            background: var(--bg-secondary);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 8px 16px;
            padding-bottom: calc(8px + var(--safe-area-bottom));
            display: none;
            justify-content: space-around;
            z-index: 1000;
            backdrop-filter: blur(20px);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 12px;
            min-width: 60px;
            transition: all 0.2s ease;
        }

        .nav-item.active {
            color: var(--primary);
            background: var(--bg-secondary);
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            padding: 60px 0 80px 0;
            min-height: 100vh;
            display: none;
        }

        .page {
            display: none;
            padding: 0;
        }

        .page.active {
            display: block;
        }

        /* User Info */
        .user-info {
            padding: 20px 16px 16px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
        }

        .user-email {
            font-size: 15px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            margin: 0 0 1px 0;
            padding: 20px 16px;
            border-bottom: 1px solid var(--border);
        }

        .card:last-child {
            margin-bottom: 0;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 0;
        }

        .stats-grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .stats-grid-4 {
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-positive { color: var(--accent-green); }
        .stat-negative { color: var(--accent-red); }
        .stat-neutral { color: var(--text-secondary); }
        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Trade List */
        .trade-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .trade-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .trade-item:active {
            background: var(--bg-secondary);
        }

        .trade-item:last-child {
            border-bottom: none;
        }

        .trade-main {
            flex: 1;
        }

        .trade-symbol {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .trade-details {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .trade-meta {
            font-size: 13px;
            color: var(--text-muted);
        }

        .trade-pnl {
            text-align: right;
            font-weight: 600;
            font-size: 16px;
        }

        .trade-pnl.positive { color: var(--accent-green); }
        .trade-pnl.negative { color: var(--accent-red); }
        .trade-pnl.neutral { color: var(--text-secondary); }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
            transition: all 0.2s ease;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--secondary);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 15px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            min-height: 44px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-input.error {
            border-color: var(--accent-red);
        }

        .form-error {
            color: var(--accent-red);
            font-size: 13px;
            margin-top: 4px;
            display: none;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
            margin: 20px 16px;
            flex-wrap: wrap;
        }

        .quick-action {
            flex: 1;
            min-width: 120px;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 200px;
            margin: 16px 0;
        }

        .chart-container-lg {
            height: 250px;
        }

        .chart-container-xl {
            height: 300px;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 3000;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-logo i {
            font-size: 64px;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .login-logo h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .login-logo p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .login-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid var(--border);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            color: var(--text-secondary);
            position: relative;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border);
        }

        .auth-divider span {
            background: var(--bg-card);
            padding: 0 16px;
            position: relative;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: calc(60px + var(--safe-area-top));
            left: 0;
            right: 0;
            z-index: 10000;
            padding: 0 16px;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.3s ease;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
        }

        .toast.success { border-left: 4px solid var(--accent-green); }
        .toast.error { border-left: 4px solid var(--accent-red); }
        .toast.warning { border-left: 4px solid var(--accent-orange); }
        .toast.info { border-left: 4px solid var(--accent-blue); }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: var(--primary);
            border: none;
            color: var(--secondary);
            font-size: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 900;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 16px;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .modal-header {
            padding: 20px 20px 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-body {
            padding: 0 20px 20px 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Advanced Analytics */
        .analytics-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        /* Heatmap */
        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin: 16px 0;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-primary);
        }

        /* Risk Metrics */
        .risk-meter {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .risk-level {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .risk-low { background: var(--accent-green); }
        .risk-medium { background: var(--accent-orange); }
        .risk-high { background: var(--accent-red); }

        /* Utility */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .text-small { font-size: 13px; }
        .mb-16 { margin-bottom: 16px; }
        .mt-16 { margin-top: 16px; }
        .hidden { display: none; }
        .loading { opacity: 0.6; pointer-events: none; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 360px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-grid-3 {
                grid-template-columns: 1fr 1fr;
            }

            .stats-grid-4 {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Écran de Connexion -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-chart-line"></i>
                <h1>Trade Journal Pro</h1>
                <p>Votre journal de trading avancé</p>
            </div>
            
            <div class="login-card">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">Connexion</button>
                    <button class="auth-tab" data-tab="signup">Inscription</button>
                </div>
                
                <form class="auth-form" id="authForm">
                    <div class="form-group">
                        <label class="form-label" for="authEmail">Email</label>
                        <input type="email" class="form-input" id="authEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="authPassword">Mot de passe</label>
                        <input type="password" class="form-input" id="authPassword" required minlength="6">
                    </div>
                    
                    <div class="form-group" id="authConfirmGroup" style="display: none;">
                        <label class="form-label" for="authConfirmPassword">Confirmer le mot de passe</label>
                        <input type="password" class="form-input" id="authConfirmPassword" minlength="6">
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block" id="authSubmit">
                        Se connecter
                    </button>
                </form>
                
                <div class="auth-divider">
                    <span>Ou continuer avec</span>
                </div>
                
                <div class="auth-form">
                    <button type="button" class="btn btn-outline btn-block" id="googleLogin">
                        <i class="fab fa-google"></i>
                        Google
                    </button>
                    
                    <button type="button" class="btn btn-outline btn-block" id="anonymousLogin">
                        <i class="fas fa-user-secret"></i>
                        Mode Invité
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <header class="header" id="appHeader">
        <div class="header-title" id="headerTitle">Tableau de bord</div>
        <div class="header-actions">
            <button class="icon-btn" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <button class="icon-btn" id="logoutButton">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- User Info -->
        <div class="user-info" id="userInfo">
            <div class="user-email" id="userEmail">email@exemple.com</div>
        </div>

        <!-- Dashboard Page -->
        <section id="dashboardPage" class="page active">
            <!-- Performance Globale -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Performance Globale</div>
                </div>
                
                <div class="stats-grid stats-grid-3">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPnl">€0.00</div>
                        <div class="stat-label">P&L Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="winRate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalTrades">0</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sharpeRatio">0.00</div>
                        <div class="stat-label">Sharpe Ratio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="maxDrawdown">0%</div>
                        <div class="stat-label">Max Drawdown</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profitFactor">0.00</div>
                        <div class="stat-label">Profit Factor</div>
                    </div>
                </div>

                <div class="chart-container-lg">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <!-- Métriques de Risque -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Métriques de Risque</div>
                </div>
                
                <div class="stats-grid stats-grid-4">
                    <div class="stat-card">
                        <div class="stat-value" id="sortinoRatio">0.00</div>
                        <div class="stat-label">Sortino Ratio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="calmarRatio">0.00</div>
                        <div class="stat-label">Calmar Ratio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="var">€0.00</div>
                        <div class="stat-label">VaR (95%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="volatility">0%</div>
                        <div class="stat-label">Volatilité</div>
                    </div>
                </div>
            </div>

            <!-- Trades Récents -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Trades Récents</div>
                    <button class="btn btn-outline" onclick="showPage('tradesPage')">
                        Voir tout
                    </button>
                </div>
                
                <div class="trade-list" id="recentTradesList">
                    <!-- Trades will be populated by JavaScript -->
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary quick-action" onclick="openTradeModal()">
                    <i class="fas fa-plus"></i>
                    Nouveau Trade
                </button>
                <button class="btn btn-outline quick-action" onclick="showPage('analyticsPage')">
                    <i class="fas fa-chart-bar"></i>
                    Analytics
                </button>
            </div>
        </section>

        <!-- Trades Page -->
        <section id="tradesPage" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Tous les Trades</div>
                    <div class="header-actions">
                        <button class="icon-btn" onclick="openTradeModal()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" data-tab="all" onclick="setTradeTab('all')">Tous</button>
                    <button class="tab" data-tab="open" onclick="setTradeTab('open')">Ouverts</button>
                    <button class="tab" data-tab="closed" onclick="setTradeTab('closed')">Fermés</button>
                    <button class="tab" data-tab="winning" onclick="setTradeTab('winning')">Gagnants</button>
                    <button class="tab" data-tab="losing" onclick="setTradeTab('losing')">Perdants</button>
                </div>
                
                <div class="trade-list" id="allTradesList">
                    <!-- Trades will be populated by JavaScript -->
                </div>
            </div>
        </section>

        <!-- Analytics Page -->
        <section id="analyticsPage" class="page">
            <!-- Analytics de Base -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Analyses Détaillées</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="analyticsProfitFactor">0.00</div>
                        <div class="stat-label">Profit Factor</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analyticsMaxDrawdown">0%</div>
                        <div class="stat-label">Max Drawdown</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analyticsBestTrade">€0.00</div>
                        <div class="stat-label">Meilleur Trade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analyticsWorstTrade">€0.00</div>
                        <div class="stat-label">Pire Trade</div>
                    </div>
                </div>

                <div class="chart-container-lg">
                    <canvas id="analyticsChart"></canvas>
                </div>
            </div>

            <!-- Distribution des P&L -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Distribution des P&L</div>
                </div>
                <div class="chart-container">
                    <canvas id="pnlDistributionChart"></canvas>
                </div>
            </div>

            <!-- Heatmap des Trades -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Heatmap des Trades</div>
                </div>
                <div class="chart-container-xl">
                    <canvas id="tradesHeatmap"></canvas>
                </div>
            </div>

            <!-- Performance Mensuelle -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Performance Mensuelle</div>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyPerformanceChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Portfolio Page -->
        <section id="portfolioPage" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Allocation du Portefeuille</div>
                </div>
                <div class="chart-container-lg">
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Performance par Classe d'Actifs</div>
                </div>
                <div class="chart-container">
                    <canvas id="assetClassChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Positions Ouvertes</div>
                </div>
                <div class="trade-list" id="openPositionsList">
                    <!-- Positions will be populated by JavaScript -->
                </div>
            </div>
        </section>

        <!-- Settings Page -->
        <section id="settingsPage" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Paramètres de Trading</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="initialCapital">Capital Initial</label>
                    <input type="number" class="form-input" id="initialCapital" value="10000" min="0" step="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="currency">Devise</label>
                    <select class="form-input" id="currency">
                        <option value="EUR">€ EUR</option>
                        <option value="USD">$ USD</option>
                        <option value="GBP">£ GBP</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="riskFreeRate">Taux Sans Risque</label>
                    <input type="number" class="form-input" id="riskFreeRate" value="2" min="0" max="10" step="0.1">
                    <div class="text-muted text-small">En pourcentage annuel</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="riskPerTrade">Risque par Trade</label>
                    <input type="number" class="form-input" id="riskPerTrade" value="2" min="0.1" max="10" step="0.1">
                    <div class="text-muted text-small">Pourcentage du capital</div>
                </div>

                <button class="btn btn-primary btn-block" onclick="saveSettings()">
                    Sauvegarder
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Gestion des Données</div>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-outline btn-block" onclick="exportCSV()">
                        <i class="fas fa-download"></i>
                        Exporter les Données
                    </button>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-outline btn-block" onclick="document.getElementById('importFile').click()">
                        <i class="fas fa-upload"></i>
                        Importer CSV
                    </button>
                    <input type="file" id="importFile" accept=".csv" class="hidden">
                </div>
                
                <div class="form-group">
                    <button class="btn btn-outline btn-block" onclick="backupData()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        Sauvegarde Cloud
                    </button>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-danger btn-block" onclick="clearAllData()">
                        <i class="fas fa-trash"></i>
                        Supprimer Toutes les Données
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" id="bottomNav">
        <button class="nav-item active" onclick="showPage('dashboardPage')">
            <i class="fas fa-chart-line nav-icon"></i>
            Dashboard
        </button>
        <button class="nav-item" onclick="showPage('tradesPage')">
            <i class="fas fa-list nav-icon"></i>
            Trades
        </button>
        <button class="nav-item" onclick="showPage('portfolioPage')">
            <i class="fas fa-pie-chart nav-icon"></i>
            Portfolio
        </button>
        <button class="nav-item" onclick="showPage('analyticsPage')">
            <i class="fas fa-chart-bar nav-icon"></i>
            Analytics
        </button>
        <button class="nav-item" onclick="showPage('settingsPage')">
            <i class="fas fa-cog nav-icon"></i>
            Réglages
        </button>
    </nav>

    <!-- FAB -->
    <button class="fab" id="fabButton" onclick="openTradeModal()">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Trade Modal -->
    <div class="modal-backdrop" id="tradeModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="tradeModalTitle">Nouveau Trade</div>
                <button class="icon-btn" onclick="closeTradeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="tradeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="symbol">Symbole</label>
                            <input type="text" class="form-input" id="symbol" placeholder="BTC/USDT" required>
                            <div class="form-error" id="symbolError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="side">Side</label>
                            <select class="form-input" id="side" required>
                                <option value="long">Long</option>
                                <option value="short">Short</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="entryPrice">Prix Entrée</label>
                            <input type="number" class="form-input" id="entryPrice" required step="0.0001" min="0.0001" inputmode="decimal">
                            <div class="form-error" id="entryPriceError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="exitPrice">Prix Sortie</label>
                            <input type="number" class="form-input" id="exitPrice" step="0.0001" min="0.0001" inputmode="decimal">
                            <div class="form-error" id="exitPriceError"></div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="quantity">Quantité</label>
                            <input type="number" class="form-input" id="quantity" required step="0.001" min="0.001" inputmode="decimal">
                            <div class="form-error" id="quantityError"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="positionSize">Taille Position</label>
                            <input type="text" class="form-input" id="positionSize" readonly>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label" for="entryDate">Date Entrée</label>
                            <input type="datetime-local" class="form-input" id="entryDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="exitDate">Date Sortie</label>
                            <input type="datetime-local" class="form-input" id="exitDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="strategy">Stratégie</label>
                        <input type="text" class="form-input" id="strategy" placeholder="Swing, Day Trading, etc.">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="notes">Notes</label>
                        <textarea class="form-input" id="notes" rows="3" placeholder="Émotions, contexte marché..."></textarea>
                    </div>

                    <div class="form-grid">
                        <button type="button" class="btn btn-outline" onclick="closeTradeModal()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDGfiBOOEZiLZmh7clQlSZAr1W6P6Si8vM",
            authDomain: "journaltrading-a6bc6.firebaseapp.com",
            projectId: "journaltrading-a6bc6",
            storageBucket: "journaltrading-a6bc6.firebasestorage.app",
            messagingSenderId: "220303277331",
            appId: "1:220303277331:web:f4251eebd62d3058f82ee6",
            measurementId: "G-8EEHYVXQS6"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ========== CLASSES ET MANAGERS ==========
        class PositionManager {
            constructor(capital, riskPerTrade = 0.02) {
                this.capital = capital;
                this.riskPerTrade = riskPerTrade;
            }
            
            calculatePositionSize(entryPrice, stopLossPrice) {
                const riskAmount = this.capital * this.riskPerTrade;
                const riskPerUnit = Math.abs(entryPrice - stopLossPrice);
                
                if (riskPerUnit <= 0) return 0;
                return riskAmount / riskPerUnit;
            }
            
            calculateRisk(quantity, entryPrice, stopLossPrice) {
                return Math.abs(entryPrice - stopLossPrice) * quantity;
            }
        }

        class RiskCalculator {
            static calculateVaR(returns, confidenceLevel = 0.95) {
                if (!returns || returns.length === 0) return 0;
                
                const sortedReturns = [...returns].sort((a, b) => a - b);
                const varIndex = Math.floor((1 - confidenceLevel) * sortedReturns.length);
                return Math.abs(sortedReturns[varIndex] || 0);
            }
            
            static calculateVolatility(returns) {
                if (!returns || returns.length < 2) return 0;
                
                const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                const variance = returns.reduce((acc, ret) => acc + Math.pow(ret - mean, 2), 0) / (returns.length - 1);
                return Math.sqrt(variance);
            }
            
            static calculateMaxDrawdown(equityCurve) {
                if (!equityCurve || equityCurve.length === 0) return 0;
                
                let peak = equityCurve[0];
                let maxDrawdown = 0;
                
                for (const value of equityCurve) {
                    if (value > peak) peak = value;
                    const drawdown = (peak - value) / peak;
                    if (drawdown > maxDrawdown) maxDrawdown = drawdown;
                }
                
                return maxDrawdown;
            }
        }

        class PerformanceMetrics {
            static calculateSharpeRatio(returns, riskFreeRate) {
                if (!returns || returns.length === 0) return 0;
                
                const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
                const volatility = RiskCalculator.calculateVolatility(returns);
                const dailyRiskFreeRate = riskFreeRate / 100 / 252;
                
                if (volatility === 0) return 0;
                return (avgReturn - dailyRiskFreeRate) / volatility;
            }
            
            static calculateSortinoRatio(returns, riskFreeRate) {
                if (!returns || returns.length === 0) return 0;
                
                const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
                const negativeReturns = returns.filter(r => r < 0);
                const downsideVolatility = RiskCalculator.calculateVolatility(negativeReturns);
                const dailyRiskFreeRate = riskFreeRate / 100 / 252;
                
                if (downsideVolatility === 0) return 0;
                return (avgReturn - dailyRiskFreeRate) / downsideVolatility;
            }
            
            static calculateCalmarRatio(returns, maxDrawdown) {
                if (!returns || returns.length === 0 || maxDrawdown === 0) return 0;
                
                const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
                return avgReturn / maxDrawdown;
            }
            
            static calculateProfitFactor(trades) {
                const winningTrades = trades.filter(t => t.pnl > 0);
                const losingTrades = trades.filter(t => t.pnl < 0);
                
                const totalWins = winningTrades.reduce((sum, t) => sum + t.pnl, 0);
                const totalLosses = Math.abs(losingTrades.reduce((sum, t) => sum + t.pnl, 0));
                
                if (totalLosses === 0) return totalWins > 0 ? Infinity : 0;
                return totalWins / totalLosses;
            }
        }

        // ========== ÉTAT GLOBAL AMÉLIORÉ ==========
        const AppState = {
            trades: [],
            settings: {
                capital: 10000,
                currency: 'EUR',
                riskFreeRate: 2,
                riskPerTrade: 2
            },
            currentUser: null,
            editingTrade: null,
            currentTradeTab: 'all',
            chartInstances: {},
            positionManager: null,
            
            // Initialisation améliorée
            init() {
                this.positionManager = new PositionManager(this.settings.capital, this.settings.riskPerTrade / 100);
                this.loadSettings();
                this.loadFromLocal();
                this.setupEventListeners();
                this.updateUI();
            },
            
            setupEventListeners() {
                // Calcul automatique de la taille de position
                document.getElementById('entryPrice').addEventListener('input', this.calculatePositionSize.bind(this));
                document.getElementById('quantity').addEventListener('input', this.calculatePositionSize.bind(this));
            },
            
            calculatePositionSize() {
                const entryPrice = parseFloat(document.getElementById('entryPrice').value);
                const quantity = parseFloat(document.getElementById('quantity').value);
                
                if (entryPrice && quantity) {
                    const positionSize = entryPrice * quantity;
                    const riskPercent = (positionSize / this.settings.capital * 100).toFixed(2);
                    document.getElementById('positionSize').value = `${this.formatCurrency(positionSize)} (${riskPercent}%)`;
                }
            },
            
            getStorageKey() {
                const userId = this.currentUser ? this.currentUser.uid : 'guest';
                return `trade_journal_${userId}`;
            },
            
            loadFromLocal() {
                try {
                    const storageKey = this.getStorageKey();
                    const storedTrades = localStorage.getItem(storageKey);
                    this.trades = storedTrades ? JSON.parse(storedTrades) : [];
                    
                    // Validation et nettoyage des données
                    this.trades = this.trades.filter(trade => 
                        trade && trade.id && trade.symbol && trade.entryPrice
                    ).map(trade => ({
                        ...trade,
                        entryPrice: parseFloat(trade.entryPrice),
                        exitPrice: trade.exitPrice ? parseFloat(trade.exitPrice) : null,
                        quantity: parseFloat(trade.quantity),
                        pnl: trade.pnl ? parseFloat(trade.pnl) : null
                    }));
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.trades = [];
                    this.showToast('Erreur lors du chargement des données', 'error');
                }
            },
            
            saveToLocal() {
                try {
                    const storageKey = this.getStorageKey();
                    localStorage.setItem(storageKey, JSON.stringify(this.trades));
                    return true;
                } catch (error) {
                    this.showToast('Erreur de sauvegarde locale', 'error');
                    return false;
                }
            },
            
            async syncWithFirebase() {
                if (!this.currentUser || this.currentUser.uid.startsWith('guest')) return;
                
                try {
                    const userRef = db.collection('users').doc(this.currentUser.uid);
                    await userRef.set({
                        trades: this.trades,
                        settings: this.settings,
                        lastSync: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error('Firebase sync error:', error);
                    return false;
                }
            },
            
            loadSettings() {
                try {
                    const settings = localStorage.getItem('trade_journal_settings');
                    if (settings) {
                        this.settings = { ...this.settings, ...JSON.parse(settings) };
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            },
            
            saveSettings() {
                try {
                    localStorage.setItem('trade_journal_settings', JSON.stringify(this.settings));
                    this.positionManager = new PositionManager(this.settings.capital, this.settings.riskPerTrade / 100);
                    return true;
                } catch (error) {
                    this.showToast('Erreur sauvegarde paramètres', 'error');
                    return false;
                }
            },
            
            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: '💡'
                };
                
                toast.innerHTML = `
                    <div>${icons[type] || icons.info}</div>
                    <div>${message}</div>
                `;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideDown 0.3s ease reverse';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 4000);
            },

            updateUI() {
                this.updateStats();
                this.updateTradeLists();
                this.updateCharts();
            },

            updateStats() {
                const closedTrades = this.getClosedTrades();
                const returns = this.calculateReturns();
                
                // P&L Total
                const totalPnl = closedTrades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
                document.getElementById('totalPnl').textContent = this.formatCurrency(totalPnl);
                document.getElementById('totalPnl').className = `stat-value ${totalPnl > 0 ? 'stat-positive' : totalPnl < 0 ? 'stat-negative' : 'stat-neutral'}`;
                
                // Win Rate
                const winningTrades = closedTrades.filter(t => (t.pnl || 0) > 0).length;
                const winRate = closedTrades.length > 0 ? (winningTrades / closedTrades.length) * 100 : 0;
                document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
                
                // Total Trades
                document.getElementById('totalTrades').textContent = this.trades.length;
                
                // Métriques avancées
                const sharpeRatio = PerformanceMetrics.calculateSharpeRatio(returns, this.settings.riskFreeRate);
                const sortinoRatio = PerformanceMetrics.calculateSortinoRatio(returns, this.settings.riskFreeRate);
                const maxDrawdown = RiskCalculator.calculateMaxDrawdown(this.getEquityCurve());
                const calmarRatio = PerformanceMetrics.calculateCalmarRatio(returns, maxDrawdown);
                const profitFactor = PerformanceMetrics.calculateProfitFactor(closedTrades);
                const varMetric = RiskCalculator.calculateVaR(returns);
                const volatility = RiskCalculator.calculateVolatility(returns) * 100;
                
                document.getElementById('sharpeRatio').textContent = sharpeRatio.toFixed(2);
                document.getElementById('sortinoRatio').textContent = sortinoRatio.toFixed(2);
                document.getElementById('maxDrawdown').textContent = (maxDrawdown * 100).toFixed(1) + '%';
                document.getElementById('calmarRatio').textContent = calmarRatio.toFixed(2);
                document.getElementById('profitFactor').textContent = profitFactor.toFixed(2);
                document.getElementById('var').textContent = this.formatCurrency(varMetric * this.settings.capital);
                document.getElementById('volatility').textContent = volatility.toFixed(1) + '%';
                
                // Analytics détaillés
                const bestTrade = closedTrades.length > 0 ? Math.max(...closedTrades.map(t => t.pnl)) : 0;
                const worstTrade = closedTrades.length > 0 ? Math.min(...closedTrades.map(t => t.pnl)) : 0;
                
                document.getElementById('analyticsProfitFactor').textContent = profitFactor.toFixed(2);
                document.getElementById('analyticsMaxDrawdown').textContent = (maxDrawdown * 100).toFixed(1) + '%';
                document.getElementById('analyticsBestTrade').textContent = this.formatCurrency(bestTrade);
                document.getElementById('analyticsBestTrade').className = `stat-value ${bestTrade > 0 ? 'stat-positive' : 'stat-neutral'}`;
                document.getElementById('analyticsWorstTrade').textContent = this.formatCurrency(worstTrade);
                document.getElementById('analyticsWorstTrade').className = `stat-value ${worstTrade < 0 ? 'stat-negative' : 'stat-neutral'}`;
            },

            getClosedTrades() {
                return this.trades.filter(trade => 
                    trade.exitPrice && !isNaN(parseFloat(trade.exitPrice)) && trade.pnl !== null
                );
            },

            calculateReturns() {
                const closedTrades = this.getClosedTrades();
                if (closedTrades.length === 0) return [];
                
                // Calcul des returns quotidiens
                const dailyPnls = {};
                closedTrades.forEach(trade => {
                    if (trade.exitDate) {
                        const date = trade.exitDate.split('T')[0];
                        dailyPnls[date] = (dailyPnls[date] || 0) + trade.pnl;
                    }
                });
                
                const equityCurve = this.getEquityCurve();
                const returns = [];
                
                for (let i = 1; i < equityCurve.length; i++) {
                    const return_ = (equityCurve[i] - equityCurve[i-1]) / equityCurve[i-1];
                    returns.push(return_);
                }
                
                return returns;
            },

            getEquityCurve() {
                const closedTrades = this.getClosedTrades();
                if (closedTrades.length === 0) return [this.settings.capital];
                
                let cumulative = this.settings.capital;
                const equityCurve = [cumulative];
                
                closedTrades
                    .sort((a, b) => new Date(a.exitDate) - new Date(b.exitDate))
                    .forEach(trade => {
                        cumulative += trade.pnl;
                        equityCurve.push(cumulative);
                    });
                
                return equityCurve;
            },

            updateTradeLists() {
                this.updateTradeList('recentTradesList', this.trades.slice(0, 5));
                this.updateAllTradesList();
                this.updateOpenPositions();
            },

            updateAllTradesList() {
                let filteredTrades = this.trades;
                
                switch (this.currentTradeTab) {
                    case 'open':
                        filteredTrades = filteredTrades.filter(t => !t.exitPrice || isNaN(parseFloat(t.exitPrice)));
                        break;
                    case 'closed':
                        filteredTrades = this.getClosedTrades();
                        break;
                    case 'winning':
                        filteredTrades = this.getClosedTrades().filter(t => t.pnl > 0);
                        break;
                    case 'losing':
                        filteredTrades = this.getClosedTrades().filter(t => t.pnl < 0);
                        break;
                }
                
                this.updateTradeList('allTradesList', filteredTrades);
            },

            updateOpenPositions() {
                const openTrades = this.trades.filter(t => !t.exitPrice || isNaN(parseFloat(t.exitPrice)));
                this.updateTradeList('openPositionsList', openTrades);
            },

            updateTradeList(elementId, trades) {
                const container = document.getElementById(elementId);
                
                if (!container) return;
                
                if (trades.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <div>Aucun trade enregistré</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = trades.map(trade => {
                    const isClosed = trade.exitPrice && !isNaN(parseFloat(trade.exitPrice));
                    let pnlDisplay, pnlClass;
                    
                    if (isClosed) {
                        pnlDisplay = `${this.formatCurrency(trade.pnl)}`;
                        pnlClass = trade.pnl > 0 ? 'positive' : trade.pnl < 0 ? 'negative' : 'neutral';
                    } else {
                        const currentValue = trade.quantity * trade.entryPrice;
                        pnlDisplay = this.formatCurrency(currentValue);
                        pnlClass = 'neutral';
                    }
                    
                    return `
                        <div class="trade-item" onclick="editTrade('${trade.id}')">
                            <div class="trade-main">
                                <div class="trade-symbol">${this.escapeHtml(trade.symbol)}</div>
                                <div class="trade-details">
                                    ${trade.side.toUpperCase()} • ${trade.quantity} @ ${trade.entryPrice}
                                    ${isClosed ? ` → ${trade.exitPrice}` : ''}
                                </div>
                                <div class="trade-meta">
                                    ${new Date(trade.entryDate).toLocaleDateString('fr-FR')}
                                    ${trade.strategy ? ` • ${this.escapeHtml(trade.strategy)}` : ''}
                                </div>
                            </div>
                            <div class="trade-pnl ${pnlClass}">
                                ${pnlDisplay}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            formatCurrency(amount) {
                if (amount === null || amount === undefined || isNaN(amount)) {
                    amount = 0;
                }
                
                const number = parseFloat(amount);
                const currency = this.settings.currency;
                const symbols = { EUR: '€', USD: '$', GBP: '£' };
                const symbol = symbols[currency] || '€';
                
                const formatted = new Intl.NumberFormat('fr-FR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(Math.abs(number));
                
                if (number >= 0) {
                    return `${symbol}${formatted}`;
                } else {
                    return `-${symbol}${formatted}`;
                }
            },

            updateCharts() {
                this.createPerformanceChart();
                this.createAnalyticsChart();
                this.createPnlDistributionChart();
                this.createTradesHeatmap();
                this.createMonthlyPerformanceChart();
                this.createAllocationChart();
                this.createAssetClassChart();
            },

            destroyChart(chartId) {
                if (this.chartInstances[chartId]) {
                    this.chartInstances[chartId].destroy();
                    this.chartInstances[chartId] = null;
                }
            },

            createPerformanceChart() {
                this.destroyChart('performanceChart');
                const ctx = document.getElementById('performanceChart').getContext('2d');
                const equityCurve = this.getEquityCurve();
                
                if (equityCurve.length <= 1) {
                    return;
                }
                
                const dates = this.getClosedTrades()
                    .sort((a, b) => new Date(a.exitDate) - new Date(b.exitDate))
                    .map(t => new Date(t.exitDate));
                
                // Ajouter la date de début
                dates.unshift(new Date(dates[0] || Date.now()));
                
                const data = equityCurve.map((value, index) => ({
                    x: dates[index] || new Date(),
                    y: value
                }));
                
                this.chartInstances.performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Courbe de Capital',
                            data: data,
                            borderColor: '#00D878',
                            backgroundColor: 'rgba(0, 216, 120, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month'
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: (value) => this.formatCurrency(value)
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Capital: ${this.formatCurrency(context.raw.y)}`
                                }
                            }
                        }
                    }
                });
            },

            createAnalyticsChart() {
                this.destroyChart('analyticsChart');
                const ctx = document.getElementById('analyticsChart').getContext('2d');
                const closedTrades = this.getClosedTrades();
                
                if (closedTrades.length === 0) return;
                
                // Performance par symbole
                const symbolData = {};
                closedTrades.forEach(trade => {
                    symbolData[trade.symbol] = (symbolData[trade.symbol] || 0) + trade.pnl;
                });
                
                const symbols = Object.keys(symbolData).slice(0, 8);
                const pnlData = symbols.map(symbol => symbolData[symbol]);
                
                this.chartInstances.analyticsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: symbols,
                        datasets: [{
                            label: 'P&L par Symbole',
                            data: pnlData,
                            backgroundColor: pnlData.map(value => value >= 0 ? '#00D878' : '#FF375F')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                ticks: {
                                    callback: (value) => this.formatCurrency(value)
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            },

            createPnlDistributionChart() {
                this.destroyChart('pnlDistributionChart');
                const ctx = document.getElementById('pnlDistributionChart').getContext('2d');
                const closedTrades = this.getClosedTrades();
                
                if (closedTrades.length === 0) return;
                
                const pnls = closedTrades.map(t => t.pnl);
                const minPnl = Math.min(...pnls);
                const maxPnl = Math.max(...pnls);
                const bucketSize = (maxPnl - minPnl) / 10;
                
                const buckets = {};
                for (let i = 0; i < 10; i++) {
                    const bucketStart = minPnl + i * bucketSize;
                    const bucketEnd = bucketStart + bucketSize;
                    buckets[`${this.formatCurrency(bucketStart)}-${this.formatCurrency(bucketEnd)}`] = 0;
                }
                
                pnls.forEach(pnl => {
                    const bucketIndex = Math.floor((pnl - minPnl) / bucketSize);
                    const bucketStart = minPnl + bucketIndex * bucketSize;
                    const bucketEnd = bucketStart + bucketSize;
                    const bucketKey = `${this.formatCurrency(bucketStart)}-${this.formatCurrency(bucketEnd)}`;
                    buckets[bucketKey]++;
                });
                
                this.chartInstances.pnlDistributionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(buckets),
                        datasets: [{
                            label: 'Nombre de Trades',
                            data: Object.values(buckets),
                            backgroundColor: '#007AFF'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: {
                                    maxRotation: 45
                                }
                            }
                        }
                    }
                });
            },

            createTradesHeatmap() {
                this.destroyChart('tradesHeatmap');
                const ctx = document.getElementById('tradesHeatmap').getContext('2d');
                const trades = this.trades;
                
                if (trades.length === 0) return;
                
                // Heatmap par jour de la semaine et heure
                const heatmapData = {};
                for (let day = 0; day < 7; day++) {
                    for (let hour = 0; hour < 24; hour++) {
                        heatmapData[`${day}-${hour}`] = 0;
                    }
                }
                
                trades.forEach(trade => {
                    const date = new Date(trade.entryDate);
                    const day = date.getDay();
                    const hour = date.getHours();
                    heatmapData[`${day}-${hour}`]++;
                });
                
                const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
                const labels = days;
                const datasets = [];
                
                for (let hour = 0; hour < 24; hour++) {
                    const data = [];
                    for (let day = 0; day < 7; day++) {
                        data.push(heatmapData[`${day}-${hour}`]);
                    }
                    datasets.push({
                        label: `${hour}h`,
                        data: data,
                        backgroundColor: this.getHeatmapColor(Math.max(...data))
                    });
                }
                
                this.chartInstances.tradesHeatmap = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Trades par créneau',
                            data: Object.values(heatmapData),
                            backgroundColor: Object.values(heatmapData).map(count => 
                                this.getHeatmapColor(count)
                            )
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Jour de la semaine'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Nombre de trades'
                                }
                            }
                        }
                    }
                });
            },

            getHeatmapColor(value) {
                const max = Math.max(1, ...Object.values(this.getHeatmapData()));
                const intensity = value / max;
                
                if (intensity < 0.2) return 'rgba(0, 120, 255, 0.1)';
                if (intensity < 0.4) return 'rgba(0, 120, 255, 0.3)';
                if (intensity < 0.6) return 'rgba(0, 120, 255, 0.5)';
                if (intensity < 0.8) return 'rgba(0, 120, 255, 0.7)';
                return 'rgba(0, 120, 255, 0.9)';
            },

            getHeatmapData() {
                const trades = this.trades;
                const heatmapData = {};
                
                for (let day = 0; day < 7; day++) {
                    for (let hour = 0; hour < 24; hour++) {
                        heatmapData[`${day}-${hour}`] = 0;
                    }
                }
                
                trades.forEach(trade => {
                    const date = new Date(trade.entryDate);
                    const day = date.getDay();
                    const hour = date.getHours();
                    heatmapData[`${day}-${hour}`]++;
                });
                
                return heatmapData;
            },

            createMonthlyPerformanceChart() {
                this.destroyChart('monthlyPerformanceChart');
                const ctx = document.getElementById('monthlyPerformanceChart').getContext('2d');
                const closedTrades = this.getClosedTrades();
                
                if (closedTrades.length === 0) return;
                
                const monthlyData = {};
                closedTrades.forEach(trade => {
                    const date = new Date(trade.exitDate);
                    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            pnl: 0,
                            trades: 0,
                            date: date
                        };
                    }
                    monthlyData[monthKey].pnl += trade.pnl;
                    monthlyData[monthKey].trades++;
                });
                
                const months = Object.keys(monthlyData).sort();
                const pnlData = months.map(month => monthlyData[month].pnl);
                const labels = months.map(month => {
                    const date = monthlyData[month].date;
                    return date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
                });
                
                this.chartInstances.monthlyPerformanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'P&L Mensuel',
                            data: pnlData,
                            backgroundColor: pnlData.map(value => value >= 0 ? '#00D878' : '#FF375F')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                ticks: {
                                    callback: (value) => this.formatCurrency(value)
                                }
                            }
                        }
                    }
                });
            },

            createAllocationChart() {
                this.destroyChart('allocationChart');
                const ctx = document.getElementById('allocationChart').getContext('2d');
                const openTrades = this.trades.filter(t => !t.exitPrice || isNaN(parseFloat(t.exitPrice)));
                
                if (openTrades.length === 0) return;
                
                const allocation = {};
                openTrades.forEach(trade => {
                    const assetClass = this.classifyAsset(trade.symbol);
                    const positionSize = trade.quantity * trade.entryPrice;
                    allocation[assetClass] = (allocation[assetClass] || 0) + positionSize;
                });
                
                this.chartInstances.allocationChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(allocation),
                        datasets: [{
                            data: Object.values(allocation),
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = context.raw;
                                        const total = Object.values(allocation).reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${context.label}: ${this.formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            },

            createAssetClassChart() {
                this.destroyChart('assetClassChart');
                const ctx = document.getElementById('assetClassChart').getContext('2d');
                const closedTrades = this.getClosedTrades();
                
                if (closedTrades.length === 0) return;
                
                const assetClassData = {};
                closedTrades.forEach(trade => {
                    const assetClass = this.classifyAsset(trade.symbol);
                    assetClassData[assetClass] = (assetClassData[assetClass] || 0) + trade.pnl;
                });
                
                this.chartInstances.assetClassChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(assetClassData),
                        datasets: [{
                            data: Object.values(assetClassData),
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.label}: ${this.formatCurrency(context.raw)}`
                                }
                            }
                        }
                    }
                });
            },

            classifyAsset(symbol) {
                symbol = symbol.toUpperCase();
                if (symbol.includes('BTC') || symbol.includes('ETH') || symbol.includes('XRP') || symbol.includes('ADA')) {
                    return 'Crypto';
                } else if (symbol.includes('EUR') || symbol.includes('USD') || symbol.includes('GBP') || symbol.includes('JPY')) {
                    return 'Forex';
                } else if (symbol.includes('.') || symbol.length <= 4) {
                    return 'Actions';
                } else {
                    return 'Autres';
                }
            },

            validateTradeForm(formData) {
                const errors = {};
                
                if (!formData.symbol || formData.symbol.trim().length === 0) {
                    errors.symbol = 'Le symbole est requis';
                }
                
                if (!formData.entryPrice || formData.entryPrice <= 0) {
                    errors.entryPrice = 'Le prix d\'entrée doit être positif';
                }
                
                if (!formData.quantity || formData.quantity <= 0) {
                    errors.quantity = 'La quantité doit être positive';
                }
                
                if (formData.exitPrice && formData.exitPrice <= 0) {
                    errors.exitPrice = 'Le prix de sortie doit être positif';
                }
                
                // Validation de la cohérence des dates
                if (formData.entryDate && formData.exitDate) {
                    const entryDate = new Date(formData.entryDate);
                    const exitDate = new Date(formData.exitDate);
                    if (exitDate < entryDate) {
                        errors.exitDate = 'La date de sortie ne peut pas être avant la date d\'entrée';
                    }
                }
                
                return errors;
            }
        };

        // ========== FONCTIONS GLOBALES ==========
        function showPage(pageId) {
            // Cacher toutes les pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Afficher la page sélectionnée
            document.getElementById(pageId).classList.add('active');
            
            // Mettre à jour la navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const navButtons = document.querySelectorAll('.nav-item');
            const pageIndex = ['dashboardPage', 'tradesPage', 'portfolioPage', 'analyticsPage', 'settingsPage'].indexOf(pageId);
            if (pageIndex !== -1 && navButtons[pageIndex]) {
                navButtons[pageIndex].classList.add('active');
            }
            
            // Mettre à jour le titre du header
            const titles = {
                dashboardPage: 'Tableau de bord',
                tradesPage: 'Mes Trades',
                portfolioPage: 'Portfolio',
                analyticsPage: 'Analytics',
                settingsPage: 'Paramètres'
            };
            document.getElementById('headerTitle').textContent = titles[pageId] || 'Trade Journal Pro';
            
            // Mettre à jour l'UI pour la page active
            if (AppState && typeof AppState.updateUI === 'function') {
                setTimeout(() => AppState.updateUI(), 100);
            }
        }

        function openTradeModal(trade = null) {
            AppState.editingTrade = trade;
            const modal = document.getElementById('tradeModal');
            const form = document.getElementById('tradeForm');
            const title = document.getElementById('tradeModalTitle');
            
            // Réinitialiser les erreurs
            document.querySelectorAll('.form-error').forEach(error => {
                error.style.display = 'none';
            });
            document.querySelectorAll('.form-input').forEach(input => {
                input.classList.remove('error');
            });
            
            if (trade) {
                title.textContent = 'Modifier le Trade';
                document.getElementById('symbol').value = trade.symbol || '';
                document.getElementById('side').value = trade.side || 'long';
                document.getElementById('entryPrice').value = trade.entryPrice || '';
                document.getElementById('exitPrice').value = trade.exitPrice || '';
                document.getElementById('quantity').value = trade.quantity || '';
                document.getElementById('strategy').value = trade.strategy || '';
                document.getElementById('notes').value = trade.notes || '';
                
                // Formater les dates pour l'input datetime-local
                if (trade.entryDate) {
                    const entryDate = new Date(trade.entryDate);
                    document.getElementById('entryDate').value = entryDate.toISOString().slice(0, 16);
                }
                if (trade.exitDate) {
                    const exitDate = new Date(trade.exitDate);
                    document.getElementById('exitDate').value = exitDate.toISOString().slice(0, 16);
                }
            } else {
                title.textContent = 'Nouveau Trade';
                form.reset();
                
                // Définir la date d'entrée par défaut à maintenant
                const now = new Date();
                document.getElementById('entryDate').value = now.toISOString().slice(0, 16);
            }
            
            // Calculer la taille de position
            AppState.calculatePositionSize();
            
            modal.style.display = 'flex';
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').style.display = 'none';
            AppState.editingTrade = null;
        }

        function setTradeTab(tab) {
            AppState.currentTradeTab = tab;
            document.querySelectorAll('#tradesPage .tab').forEach(t => {
                t.classList.remove('active');
            });
            const activeTab = document.querySelector(`#tradesPage .tab[data-tab="${tab}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            AppState.updateAllTradesList();
        }

        function editTrade(tradeId) {
            const trade = AppState.trades.find(t => t.id === tradeId);
            if (trade) {
                openTradeModal(trade);
            }
        }

        function saveSettings() {
            const capital = parseFloat(document.getElementById('initialCapital').value) || 10000;
            const riskPerTrade = parseFloat(document.getElementById('riskPerTrade').value) || 2;
            
            if (capital <= 0) {
                AppState.showToast('Le capital initial doit être positif', 'error');
                return;
            }
            
            if (riskPerTrade <= 0 || riskPerTrade > 50) {
                AppState.showToast('Le risque par trade doit être entre 0.1% et 50%', 'error');
                return;
            }
            
            AppState.settings.capital = capital;
            AppState.settings.currency = document.getElementById('currency').value;
            AppState.settings.riskFreeRate = parseFloat(document.getElementById('riskFreeRate').value) || 2;
            AppState.settings.riskPerTrade = riskPerTrade;
            
            if (AppState.saveSettings()) {
                AppState.showToast('Paramètres sauvegardés', 'success');
                AppState.updateUI();
            }
        }

        function exportCSV() {
            if (AppState.trades.length === 0) {
                AppState.showToast('Aucun trade à exporter', 'warning');
                return;
            }
            
            const headers = ['ID', 'Symbol', 'Side', 'Entry Price', 'Exit Price', 'Quantity', 'P&L', 'Entry Date', 'Exit Date', 'Strategy', 'Notes'];
            const csvData = [headers];
            
            AppState.trades.forEach(trade => {
                const row = [
                    trade.id,
                    `"${trade.symbol}"`,
                    trade.side,
                    trade.entryPrice,
                    trade.exitPrice || '',
                    trade.quantity,
                    trade.pnl || '',
                    trade.entryDate,
                    trade.exitDate || '',
                    `"${trade.strategy || ''}"`,
                    `"${trade.notes || ''}"`
                ];
                csvData.push(row);
            });
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `trades_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            AppState.showToast('CSV exporté avec succès', 'success');
        }

        function importCSV(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    const newTrades = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        const trade = {};
                        
                        headers.forEach((header, index) => {
                            if (values[index]) {
                                trade[header.toLowerCase()] = values[index];
                            }
                        });
                        
                        // Convertir les types
                        if (trade.entryprice) trade.entryPrice = parseFloat(trade.entryprice);
                        if (trade.exitprice) trade.exitPrice = parseFloat(trade.exitprice);
                        if (trade.quantity) trade.quantity = parseFloat(trade.quantity);
                        if (trade.pnl) trade.pnl = parseFloat(trade.pnl);
                        
                        // Générer un ID si manquant
                        if (!trade.id) {
                            trade.id = 'imported_' + Date.now() + '_' + i;
                        }
                        
                        newTrades.push(trade);
                    }
                    
                    AppState.trades = [...newTrades, ...AppState.trades];
                    if (AppState.saveToLocal()) {
                        AppState.showToast(`${newTrades.length} trades importés`, 'success');
                        AppState.updateUI();
                    }
                } catch (error) {
                    AppState.showToast('Erreur lors de l\'import CSV', 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
        }

        function backupData() {
            if (AppState.syncWithFirebase()) {
                AppState.showToast('Sauvegarde cloud réussie', 'success');
            } else {
                AppState.showToast('Erreur sauvegarde cloud', 'error');
            }
        }

        function clearAllData() {
            if (confirm('Êtes-vous sûr de vouloir supprimer TOUTES les données ? Cette action est irréversible.')) {
                AppState.trades = [];
                AppState.saveToLocal();
                AppState.updateUI();
                AppState.showToast('Toutes les données ont été supprimées', 'success');
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('trade_journal_theme', newTheme);
            
            const icon = document.querySelector('#themeToggle i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            // Recréer les graphiques avec le nouveau thème
            setTimeout(() => AppState.updateCharts(), 100);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('trade_journal_theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const icon = document.querySelector('#themeToggle i');
            if (icon) {
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // ========== INITIALISATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser l'application
            AppState.init();
            loadTheme();
            loadSettingsToUI();
            
            // Gestion de l'authentification
            const authTabs = document.querySelectorAll('.auth-tab');
            const authForm = document.getElementById('authForm');
            const authConfirmGroup = document.getElementById('authConfirmGroup');
            const authSubmit = document.getElementById('authSubmit');
            
            let currentAuthTab = 'login';
            
            authTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    currentAuthTab = this.dataset.tab;
                    
                    authTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    authConfirmGroup.style.display = currentAuthTab === 'signup' ? 'block' : 'none';
                    authSubmit.textContent = currentAuthTab === 'signup' ? 'Créer un compte' : 'Se connecter';
                });
            });
            
            authForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                const confirmPassword = document.getElementById('authConfirmPassword').value;
                
                if (currentAuthTab === 'signup' && password !== confirmPassword) {
                    AppState.showToast('Les mots de passe ne correspondent pas', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    AppState.showToast('Le mot de passe doit faire au moins 6 caractères', 'error');
                    return;
                }
                
                authSubmit.disabled = true;
                authSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';
                
                try {
                    // Simulation de connexion réussie
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    initializeApp({
                        email: email,
                        uid: 'user_' + Date.now()
                    });
                } catch (error) {
                    AppState.showToast('Erreur de connexion', 'error');
                    authSubmit.disabled = false;
                    authSubmit.textContent = currentAuthTab === 'signup' ? 'Créer un compte' : 'Se connecter';
                }
            });
            
            document.getElementById('googleLogin').addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connexion...';
                
                setTimeout(() => {
                    initializeApp({
                        email: 'utilisateur.google@gmail.com',
                        uid: 'google_user_' + Date.now()
                    });
                }, 1000);
            });
            
            document.getElementById('anonymousLogin').addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connexion...';
                
                setTimeout(() => {
                    initializeApp({
                        email: 'Mode Invité',
                        uid: 'guest_' + Date.now()
                    });
                }, 1000);
            });
            
            // Gestion du formulaire de trade
            document.getElementById('tradeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    symbol: document.getElementById('symbol').value.trim(),
                    side: document.getElementById('side').value,
                    entryPrice: parseFloat(document.getElementById('entryPrice').value),
                    exitPrice: document.getElementById('exitPrice').value ? parseFloat(document.getElementById('exitPrice').value) : null,
                    quantity: parseFloat(document.getElementById('quantity').value),
                    entryDate: document.getElementById('entryDate').value || new Date().toISOString(),
                    exitDate: document.getElementById('exitDate').value || null,
                    strategy: document.getElementById('strategy').value.trim(),
                    notes: document.getElementById('notes').value.trim()
                };
                
                // Validation
                const errors = AppState.validateTradeForm(formData);
                if (Object.keys(errors).length > 0) {
                    // Afficher les erreurs
                    Object.keys(errors).forEach(field => {
                        const errorElement = document.getElementById(field + 'Error');
                        const inputElement = document.getElementById(field);
                        if (errorElement && inputElement) {
                            errorElement.textContent = errors[field];
                            errorElement.style.display = 'block';
                            inputElement.classList.add('error');
                        }
                    });
                    return;
                }
                
                // Cacher les erreurs
                document.querySelectorAll('.form-error').forEach(error => {
                    error.style.display = 'none';
                });
                document.querySelectorAll('.form-input').forEach(input => {
                    input.classList.remove('error');
                });
                
                // Calcul du P&L
                if (formData.exitPrice) {
                    let pnl;
                    if (formData.side === 'long') {
                        pnl = (formData.exitPrice - formData.entryPrice) * formData.quantity;
                    } else {
                        pnl = (formData.entryPrice - formData.exitPrice) * formData.quantity;
                    }
                    formData.pnl = parseFloat(pnl.toFixed(2));
                } else {
                    formData.pnl = null;
                }
                
                if (AppState.editingTrade) {
                    // Mise à jour du trade existant
                    const tradeIndex = AppState.trades.findIndex(t => t.id === AppState.editingTrade.id);
                    AppState.trades[tradeIndex] = { 
                        ...AppState.trades[tradeIndex], 
                        ...formData 
                    };
                } else {
                    // Nouveau trade
                    const trade = {
                        id: 'trade_' + Date.now(),
                        ...formData
                    };
                    AppState.trades.unshift(trade);
                }
                
                if (AppState.saveToLocal()) {
                    AppState.showToast(AppState.editingTrade ? 'Trade modifié' : 'Trade ajouté', 'success');
                    AppState.updateUI();
                    closeTradeModal();
                    
                    // Synchronisation Firebase
                    AppState.syncWithFirebase();
                }
            });
            
            // Boutons d'interface
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('logoutButton').addEventListener('click', signOut);
            
            // Fermer les modales en cliquant à l'extérieur
            document.getElementById('tradeModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTradeModal();
                }
            });
            
            // Import CSV
            document.getElementById('importFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                        importCSV(file);
                    } else {
                        AppState.showToast('Veuillez sélectionner un fichier CSV', 'error');
                    }
                }
                this.value = '';
            });
            
            // Gestion du clavier
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeTradeModal();
                }
            });
        });

        function initializeApp(user) {
            AppState.currentUser = user;
            
            // Afficher l'interface principale
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appHeader').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('bottomNav').style.display = 'flex';
            document.getElementById('fabButton').style.display = 'flex';
            
            // Mettre à jour les infos utilisateur
            document.getElementById('userEmail').textContent = user.email;
            
            // Charger les données
            AppState.loadFromLocal();
            AppState.updateUI();
            
            AppState.showToast(`Bienvenue ${user.email || 'Utilisateur'} !`, 'success');
        }

        function signOut() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appHeader').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('bottomNav').style.display = 'none';
                document.getElementById('fabButton').style.display = 'none';
                
                // Réinitialiser les formulaires
                document.getElementById('authForm').reset();
                
                AppState.currentUser = null;
                AppState.showToast('Déconnexion réussie', 'success');
            }
        }

        function loadSettingsToUI() {
            document.getElementById('initialCapital').value = AppState.settings.capital;
            document.getElementById('currency').value = AppState.settings.currency;
            document.getElementById('riskFreeRate').value = AppState.settings.riskFreeRate;
            document.getElementById('riskPerTrade').value = AppState.settings.riskPerTrade;
        }

        // Exposer les fonctions globales
        window.showPage = showPage;
        window.openTradeModal = openTradeModal;
        window.closeTradeModal = closeTradeModal;
        window.setTradeTab = setTradeTab;
        window.editTrade = editTrade;
        window.saveSettings = saveSettings;
        window.exportCSV = exportCSV;
        window.clearAllData = clearAllData;
        window.backupData = backupData;
    </script>
</body>
</html>
