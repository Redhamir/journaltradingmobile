<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <!-- IC√îNES PWA -->
  <meta name="apple-mobile-web-app-title" content="Trading Journal">
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icon-167.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  <link rel="icon" type="image/png" href="icon-192.png">
  
  <!-- CONFIGURATION PWA -->
  <meta name="theme-color" content="#00C48C">
  <meta name="msapplication-TileColor" content="#00C48C">
  <link rel="manifest" href="manifest.json">
  
  <title>Journal de trading ‚Äî Mobile</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #0A0A0A;
      --bg-card: #1A1A1A;
      --fg: #F5F5F5;
      --muted: #A8A8A8;
      --accent-green: #00C48C;
      --accent-red: #FF5C63;
      --accent-blue: #3B82F6;
      --glass: rgba(30, 30, 30, 0.95);
      --border: rgba(255,255,255,0.15);
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
      --overlay: rgba(0,0,0,0.8);
    }

    [data-theme="light"] {
      --bg: #FFFFFF;
      --bg-card: #F8F9FA;
      --fg: #1A1A1A;
      --muted: #666666;
      --accent-green: #00A876;
      --accent-red: #E53E3E;
      --accent-blue: #1D4ED8;
      --glass: rgba(248, 249, 250, 0.95);
      --border: rgba(0,0,0,0.15);
      --shadow: 0 8px 32px rgba(0,0,0,0.1);
      --overlay: rgba(0,0,0,0.4);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
      position: fixed;
      width: 100%;
    }

    /* Container principal */
    .app {
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      background: var(--bg);
    }

    /* Header mobile */
    .mobile-header {
      padding: 12px 16px;
      padding-top: max(12px, env(safe-area-inset-top));
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 60px;
      position: relative;
      z-index: 100;
    }

    .header-title {
      font-weight: 700;
      font-size: 18px;
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: transparent;
      color: var(--fg);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
    }

    .icon-btn:active {
      background: var(--border);
    }

    /* Navigation bottom */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 8px 16px;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      display: flex;
      justify-content: space-around;
      z-index: 1000;
    }

    .nav-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      color: var(--muted);
      padding: 8px 4px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 10px;
      min-height: 50px;
      max-width: 80px;
    }

    .nav-tab.active {
      color: var(--accent-green);
    }

    .nav-tab:active {
      background: var(--border);
    }

    .tab-icon {
      font-size: 20px;
      margin-bottom: 2px;
    }

    /* Content area */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      padding-bottom: 80px; /* Espace pour la bottom nav */
      -webkit-overflow-scrolling: touch;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    /* Quick actions */
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .quick-action {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-action:active {
      transform: scale(0.98);
      background: var(--border);
    }

    .action-icon {
      font-size: 24px;
      margin-bottom: 8px;
      display: block;
    }

    .action-text {
      font-weight: 600;
      font-size: 14px;
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
    }

    /* Trades list */
    .trades-section {
      margin-top: 20px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-title {
      font-weight: 700;
      font-size: 18px;
      margin: 0;
    }

    .see-all {
      color: var(--accent-green);
      font-size: 14px;
      text-decoration: none;
    }

    .trade-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 8px;
      border-left: 4px solid transparent;
    }

    .trade-item.win {
      background: linear-gradient(90deg, rgba(0,196,140,0.1), transparent);
      border-left-color: var(--accent-green);
    }

    .trade-item.loss {
      background: linear-gradient(90deg, rgba(255,92,99,0.1), transparent);
      border-left-color: var(--accent-red);
    }

    .trade-info {
      flex: 1;
    }

    .trade-symbol {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .trade-details {
      font-size: 12px;
      color: var(--muted);
    }

    .trade-pnl {
      text-align: right;
    }

    .trade-amount {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 2px;
    }

    .trade-percent {
      font-size: 12px;
      color: var(--muted);
    }

    /* Modal mobile */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--overlay);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(10px);
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      padding: 20px;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-weight: 700;
      font-size: 20px;
      margin: 0;
    }

    /* Form styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }

    .form-input {
      width: 100%;
      padding: 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--fg);
      font-size: 16px;
      -webkit-appearance: none;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-green);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Button styles */
    .btn {
      padding: 16px 24px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 54px;
      transition: all 0.2s ease;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-green), #00E095);
      color: white;
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--fg);
      border: 1px solid var(--border);
    }

    .btn-full {
      width: 100%;
    }

    /* Toast system */
    .toast-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3000;
      width: 90%;
      max-width: 400px;
    }

    .toast {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: var(--shadow);
      animation: slideDown 0.3s ease;
    }

    .toast.success {
      border-left: 4px solid var(--accent-green);
    }

    .toast.error {
      border-left: 4px solid var(--accent-red);
    }

    .toast.fade-out {
      animation: slideUp 0.3s ease forwards;
    }

    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-100%); opacity: 0; }
    }

    /* Chart container */
    .chart-container {
      height: 200px;
      margin: 20px 0;
      position: relative;
    }

    /* Heatmap mobile */
    .heatmap-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 16px 0;
    }

    .heatmap {
      display: grid;
      grid-template-columns: repeat(14, 1fr);
      gap: 4px;
      min-width: 500px;
    }

    .heat-cell {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }

    /* Loading states */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .skeleton {
      background: linear-gradient(90deg, var(--border) 25%, var(--bg) 50%, var(--border) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Utility classes */
    .text-success { color: var(--accent-green); }
    .text-danger { color: var(--accent-red); }
    .text-muted { color: var(--muted); }
    .text-center { text-align: center; }
    .mb-16 { margin-bottom: 16px; }
    .mt-16 { margin-top: 16px; }
    .hidden { display: none; }

    /* Swipe gestures for modals */
    .modal-content {
      touch-action: pan-y;
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Main App -->
  <div class="app">
    <!-- Header -->
    <header class="mobile-header">
      <h1 class="header-title" id="pageTitle">Tableau de bord</h1>
      <div class="header-actions">
        <button class="icon-btn" id="themeToggle">üåì</button>
        <button class="icon-btn" id="syncButton">‚ö°</button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="content" id="mainContent">
      <!-- Dashboard View -->
      <div class="view" id="dashboardView">
        <!-- Quick Actions -->
        <div class="quick-actions">
          <div class="quick-action" id="quickTrade">
            <span class="action-icon">üìà</span>
            <span class="action-text">Nouveau Trade</span>
          </div>
          <div class="quick-action" id="quickImport">
            <span class="action-icon">üì•</span>
            <span class="action-text">Importer CSV</span>
          </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="currentCapital">-- ‚Ç¨</div>
            <div class="stat-label">Capital</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="winRate">0%</div>
            <div class="stat-label">Win Rate</div>
          </div>
        </div>

        <!-- Equity Chart -->
        <div class="card">
          <div class="section-header">
            <h3 class="section-title">Performance</h3>
          </div>
          <div class="chart-container">
            <canvas id="equityChart"></canvas>
          </div>
        </div>

        <!-- Recent Trades -->
        <div class="trades-section">
          <div class="section-header">
            <h3 class="section-title">Trades r√©cents</h3>
            <a href="#" class="see-all" data-view="trades">Tout voir</a>
          </div>
          <div id="recentTradesList">
            <!-- Trades will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Trades View -->
      <div class="view hidden" id="tradesView">
        <div class="card">
          <div class="section-header">
            <h3 class="section-title">Tous les trades</h3>
            <button class="icon-btn" id="filterButton">üîç</button>
          </div>
          <div id="allTradesList">
            <!-- All trades will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Analytics View -->
      <div class="view hidden" id="analyticsView">
        <div class="card">
          <h3 class="section-title mb-16">Analytics</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="profitFactor">--</div>
              <div class="stat-label">Profit Factor</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="expectancy">-- ‚Ç¨</div>
              <div class="stat-label">Expectancy</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="bestTrade">-- ‚Ç¨</div>
              <div class="stat-label">Meilleur</div>
            </div>
            <div class="stat-card">
              <div class="stat-value text-danger" id="worstTrade">-- ‚Ç¨</div>
              <div class="stat-label">Pire</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="section-title mb-16">Heatmap 30j</h3>
          <div class="heatmap-container">
            <div class="heatmap" id="heatmap"></div>
          </div>
        </div>
      </div>

      <!-- Settings View -->
      <div class="view hidden" id="settingsView">
        <div class="card">
          <h3 class="section-title mb-16">Param√®tres</h3>
          <div class="form-group">
            <label class="form-label">Capital initial</label>
            <input type="number" class="form-input" id="initialCapital" placeholder="10000">
          </div>
          <button class="btn btn-primary btn-full" id="saveCapitalSettings">
            üíæ Sauvegarder le capital
          </button>
        </div>
      </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <button class="nav-tab active" data-view="dashboard">
        <span class="tab-icon">üìä</span>
        <span>Dashboard</span>
      </button>
      <button class="nav-tab" data-view="trades">
        <span class="tab-icon">üìà</span>
        <span>Trades</span>
      </button>
      <button class="nav-tab" data-view="analytics">
        <span class="tab-icon">üìâ</span>
        <span>Analytics</span>
      </button>
      <button class="nav-tab" data-view="settings">
        <span class="tab-icon">‚öôÔ∏è</span>
        <span>Settings</span>
      </button>
    </nav>
  </div>

  <!-- New Trade Modal -->
  <div class="modal-overlay" id="tradeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Nouveau Trade</h2>
        <button class="icon-btn" id="closeTradeModal">‚úï</button>
      </div>
      
      <form id="tradeForm">
        <div class="form-group">
          <label class="form-label">Symbole</label>
          <input type="text" class="form-input" name="symbol" placeholder="BTC, ETH..." required>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Side</label>
            <select class="form-input" name="side">
              <option value="long">Long</option>
              <option value="short">Short</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Size</label>
            <input type="number" class="form-input" name="size" step="0.001" placeholder="1.0" required>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Entry Price</label>
            <input type="number" class="form-input" name="entry_price" step="0.01" placeholder="0.00" required>
          </div>
          <div class="form-group">
            <label class="form-label">Exit Price</label>
            <input type="number" class="form-input" name="exit_price" step="0.01" placeholder="Laissez vide si ouvert">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Frais</label>
            <input type="number" class="form-input" name="fees" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label class="form-label">Taxes</label>
            <input type="number" class="form-input" name="taxes" step="0.01" value="0">
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-full">
          üíæ Enregistrer le Trade
        </button>
      </form>
    </div>
  </div>

  <!-- CSV Import Modal -->
  <div class="modal-overlay" id="importModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Importer CSV</h2>
        <button class="icon-btn" id="closeImportModal">‚úï</button>
      </div>

      <div class="form-group">
        <label class="form-label">Fichier CSV</label>
        <input type="file" class="form-input" id="csvFile" accept=".csv">
      </div>

      <button class="btn btn-primary btn-full mt-16" id="processCSV">
        üì• Importer
      </button>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION SUPABASE ==========
    const SUPABASE_URL = 'https://jbdtjiffupkqxomktzyd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpiZHRqaWZmdXBrcXhvbWt0enlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNDAzMzUsImV4cCI6MjA3NjYxNjMzNX0.ZkZq-_246t2hzsQre4XN5EOak0Ey2JmSDyU2_ElNacc';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ========== √âTAT DE L'APPLICATION ==========
    let trades = [];
    let capital = 10000;
    let currentUser = null;
    let equityChart = null;

    // ========== SYST√àME DE TOAST ==========
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: 'üí°'
      };
      
      toast.innerHTML = `
        <div>${icons[type] || icons.info}</div>
        <div style="flex: 1;">${message}</div>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ========== GESTION DU TH√àME ==========
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      let theme = savedTheme;
      if (savedTheme === 'auto') {
        theme = systemPrefersDark ? 'dark' : 'light';
      }
      
      document.documentElement.setAttribute('data-theme', theme);
      
      const themeIcon = document.getElementById('themeToggle');
      themeIcon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const themeIcon = document.getElementById('themeToggle');
      themeIcon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
      
      // Re-init charts with new theme
      if (equityChart) {
        equityChart.destroy();
        initChart();
        updateChart();
      }
    }

    // ========== GESTION DES MODALES ==========
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = 'flex';
      setTimeout(() => modal.classList.add('active'), 10);
      document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('active');
      setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }, 300);
    }

    // ========== NAVIGATION ==========
    function showView(viewName) {
      // Hide all views
      document.querySelectorAll('.view').forEach(view => {
        view.classList.add('hidden');
      });
      
      // Show target view
      document.getElementById(viewName + 'View').classList.remove('hidden');
      
      // Update page title
      const titles = {
        dashboard: 'Tableau de bord',
        trades: 'Trades',
        analytics: 'Analytics',
        settings: 'Param√®tres'
      };
      document.getElementById('pageTitle').textContent = titles[viewName];
      
      // Update active tab
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
      
      // Update analytics if needed
      if (viewName === 'analytics') {
        updateAnalytics();
        renderHeatmap();
      }
    }

    // ========== GESTION DES DONN√âES ==========
    function loadTrades() {
      const stored = localStorage.getItem('mobile_trades');
      trades = stored ? JSON.parse(stored) : [];
      renderTrades();
      updateDashboard();
    }

    function saveTrades() {
      localStorage.setItem('mobile_trades', JSON.stringify(trades));
    }

    function computePnL(trade) {
      if (!trade.exit_price) return null;
      
      let pnl;
      if (trade.side === 'long') {
        pnl = (trade.exit_price - trade.entry_price) * trade.size - (trade.fees || 0) - (trade.taxes || 0);
      } else {
        pnl = (trade.entry_price - trade.exit_price) * trade.size - (trade.fees || 0) - (trade.taxes || 0);
      }
      
      return parseFloat(pnl.toFixed(2));
    }

    // ========== RENDU DES TRADES ==========
    function renderTrades() {
      const recentList = document.getElementById('recentTradesList');
      const allList = document.getElementById('allTradesList');
      
      const recentTrades = trades.slice(0, 5);
      const allTrades = trades;
      
      // Recent trades
      if (recentTrades.length === 0) {
        recentList.innerHTML = '<div class="text-center text-muted">Aucun trade enregistr√©</div>';
      } else {
        recentList.innerHTML = recentTrades.map(trade => `
          <div class="trade-item ${trade.pnl >= 0 ? 'win' : 'loss'}">
            <div class="trade-info">
              <div class="trade-symbol">${trade.symbol}</div>
              <div class="trade-details">${trade.side} ‚Ä¢ ${trade.size} @ ${trade.entry_price}</div>
            </div>
            <div class="trade-pnl">
              <div class="trade-amount ${trade.pnl >= 0 ? 'text-success' : 'text-danger'}">
                ${trade.pnl ? (trade.pnl >= 0 ? '+' : '') + trade.pnl + ' ‚Ç¨' : 'OUVERT'}
              </div>
              <div class="trade-percent">
                ${trade.pnl ? ((trade.pnl / (trade.entry_price * trade.size)) * 100).toFixed(2) + '%' : '‚Äî'}
              </div>
            </div>
          </div>
        `).join('');
      }
      
      // All trades
      if (allTrades.length === 0) {
        allList.innerHTML = '<div class="text-center text-muted">Aucun trade enregistr√©</div>';
      } else {
        allList.innerHTML = allTrades.map(trade => `
          <div class="trade-item ${trade.pnl >= 0 ? 'win' : 'loss'}">
            <div class="trade-info">
              <div class="trade-symbol">${trade.symbol}</div>
              <div class="trade-details">${trade.side} ‚Ä¢ ${trade.size} @ ${trade.entry_price}</div>
            </div>
            <div class="trade-pnl">
              <div class="trade-amount ${trade.pnl >= 0 ? 'text-success' : 'text-danger'}">
                ${trade.pnl ? (trade.pnl >= 0 ? '+' : '') + trade.pnl + ' ‚Ç¨' : 'OUVERT'}
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    // ========== MISE √Ä JOUR DU DASHBOARD ==========
    function updateDashboard() {
      const closedTrades = trades.filter(t => t.pnl !== null);
      const winningTrades = closedTrades.filter(t => t.pnl > 0);
      const winRate = closedTrades.length > 0 ? Math.round((winningTrades.length / closedTrades.length) * 100) : 0;
      
      const totalPnL = closedTrades.reduce((sum, t) => sum + t.pnl, 0);
      const currentCapitalValue = capital + totalPnL;
      
      document.getElementById('currentCapital').textContent = currentCapitalValue.toFixed(2) + ' ‚Ç¨';
      document.getElementById('winRate').textContent = winRate + '%';
    }

    function updateAnalytics() {
      const closedTrades = trades.filter(t => t.pnl !== null);
      
      if (closedTrades.length === 0) {
        document.getElementById('profitFactor').textContent = '--';
        document.getElementById('expectancy').textContent = '-- ‚Ç¨';
        document.getElementById('bestTrade').textContent = '-- ‚Ç¨';
        document.getElementById('worstTrade').textContent = '-- ‚Ç¨';
        return;
      }
      
      const totalWins = closedTrades.filter(t => t.pnl > 0).reduce((sum, t) => sum + t.pnl, 0);
      const totalLosses = Math.abs(closedTrades.filter(t => t.pnl < 0).reduce((sum, t) => sum + t.pnl, 0));
      const profitFactor = totalLosses > 0 ? (totalWins / totalLosses).toFixed(2) : '‚àû';
      
      const avgPnL = closedTrades.reduce((sum, t) => sum + t.pnl, 0) / closedTrades.length;
      
      const bestTrade = Math.max(...closedTrades.map(t => t.pnl));
      const worstTrade = Math.min(...closedTrades.map(t => t.pnl));
      
      document.getElementById('profitFactor').textContent = profitFactor;
      document.getElementById('expectancy').textContent = avgPnL.toFixed(2) + ' ‚Ç¨';
      document.getElementById('bestTrade').textContent = '+' + bestTrade.toFixed(2) + ' ‚Ç¨';
      document.getElementById('worstTrade').textContent = worstTrade.toFixed(2) + ' ‚Ç¨';
    }

    // ========== GRAPHIQUE ==========
    function initChart() {
      const ctx = document.getElementById('equityChart');
      if (!ctx) return;
      
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      
      equityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Capital',
            data: [],
            borderColor: '#00C48C',
            backgroundColor: 'rgba(0, 196, 140, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              display: false
            },
            y: {
              display: true,
              grid: {
                color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
              },
              ticks: {
                color: isDark ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.7)'
              }
            }
          }
        }
      });
    }

    function updateChart() {
      if (!equityChart) return;
      
      const closedTrades = trades.filter(t => t.pnl !== null);
      let currentCapital = capital;
      const data = [currentCapital];
      
      closedTrades.forEach(trade => {
        currentCapital += trade.pnl;
        data.push(currentCapital);
      });
      
      equityChart.data.datasets[0].data = data;
      equityChart.data.labels = Array(data.length).fill('');
      equityChart.update();
    }

    // ========== HEATMAP ==========
    function renderHeatmap() {
      const container = document.getElementById('heatmap');
      if (!container) return;
      
      container.innerHTML = '';
      const days = 30;
      const now = new Date();
      
      for (let i = days - 1; i >= 0; i--) {
        const day = new Date(now);
        day.setDate(now.getDate() - i);
        
        const dayTrades = trades.filter(t => {
          if (!t.exit_timestamp) return false;
          const tradeDate = new Date(t.exit_timestamp);
          return tradeDate.toDateString() === day.toDateString();
        });
        
        const dayPnL = dayTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
        
        const cell = document.createElement('div');
        cell.className = 'heat-cell';
        cell.title = `${day.toLocaleDateString()}: ${dayPnL.toFixed(2)} ‚Ç¨`;
        
        if (dayPnL > 0) {
          const intensity = Math.min(dayPnL / 100, 1);
          cell.style.background = `rgba(0, 196, 140, ${0.3 + intensity * 0.7})`;
        } else if (dayPnL < 0) {
          const intensity = Math.min(Math.abs(dayPnL) / 100, 1);
          cell.style.background = `rgba(255, 92, 99, ${0.3 + intensity * 0.7})`;
        }
        
        if (Math.abs(dayPnL) > 10) {
          cell.textContent = Math.abs(Math.round(dayPnL));
        }
        
        container.appendChild(cell);
      }
    }

    // ========== GESTION DES √âV√âNEMENTS ==========
    document.addEventListener('DOMContentLoaded', function() {
      // Initialisation
      initTheme();
      loadTrades();
      initChart();
      updateChart();
      renderHeatmap();
      
      // Load capital from localStorage
      const savedCapital = localStorage.getItem('capital');
      if (savedCapital) {
        capital = parseFloat(savedCapital);
        document.getElementById('initialCapital').value = capital;
      }
      
      // Navigation
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const view = tab.getAttribute('data-view');
          showView(view);
        });
      });
      
      document.querySelectorAll('.see-all').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const view = link.getAttribute('data-view');
          showView(view);
        });
      });
      
      // Quick actions
      document.getElementById('quickTrade').addEventListener('click', () => {
        openModal('tradeModal');
      });
      
      document.getElementById('quickImport').addEventListener('click', () => {
        openModal('importModal');
      });
      
      // Theme toggle
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      
      // Sync button
      document.getElementById('syncButton').addEventListener('click', () => {
        showToast('Synchronisation en cours...', 'info');
        // Impl√©mentez la synchronisation ici si n√©cessaire
      });
      
      // Trade form
      document.getElementById('tradeForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const trade = {
          id: 't_' + Math.random().toString(36).substr(2, 9),
          symbol: formData.get('symbol').toUpperCase(),
          side: formData.get('side'),
          size: parseFloat(formData.get('size')),
          entry_price: parseFloat(formData.get('entry_price')),
          exit_price: formData.get('exit_price') ? parseFloat(formData.get('exit_price')) : null,
          fees: parseFloat(formData.get('fees')) || 0,
          taxes: parseFloat(formData.get('taxes')) || 0,
          timestamp: new Date().toISOString()
        };
        
        trade.pnl = computePnL(trade);
        trades.unshift(trade);
        saveTrades();
        renderTrades();
        updateDashboard();
        updateChart();
        renderHeatmap();
        
        closeModal('tradeModal');
        showToast('Trade enregistr√© avec succ√®s!', 'success');
        e.target.reset();
      });
      
      // Save capital
      document.getElementById('saveCapitalSettings').addEventListener('click', () => {
        const newCapital = parseFloat(document.getElementById('initialCapital').value);
        
        if (!isNaN(newCapital) && newCapital > 0) {
          capital = newCapital;
          localStorage.setItem('capital', capital.toString());
          updateDashboard();
          updateChart();
          showToast('Capital sauvegard√©', 'success');
        } else {
          showToast('Veuillez entrer un capital valide', 'error');
        }
      });
      
      // CSV Import
      document.getElementById('processCSV').addEventListener('click', () => {
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];
        
        if (!file) {
          showToast('Veuillez s√©lectionner un fichier', 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const csv = e.target.result;
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            let imported = 0;
            for (let i = 1; i < lines.length; i++) {
              if (!lines[i].trim()) continue;
              
              const values = lines[i].split(',').map(v => v.trim());
              const trade = {};
              
              headers.forEach((header, index) => {
                trade[header] = values[index];
              });
              
              // Convert numeric values
              trade.size = parseFloat(trade.size);
              trade.entry_price = parseFloat(trade.entry_price);
              trade.exit_price = trade.exit_price ? parseFloat(trade.exit_price) : null;
              trade.fees = parseFloat(trade.fees) || 0;
              trade.taxes = parseFloat(trade.taxes) || 0;
              trade.pnl = computePnL(trade);
              
              if (!trade.id) {
                trade.id = 't_' + Math.random().toString(36).substr(2, 9);
              }
              
              trades.push(trade);
              imported++;
            }
            
            saveTrades();
            renderTrades();
            updateDashboard();
            updateChart();
            renderHeatmap();
            
            closeModal('importModal');
            showToast(`${imported} trades import√©s avec succ√®s`, 'success');
            fileInput.value = '';
            
          } catch (error) {
            showToast('Erreur lors de l\'import: ' + error.message, 'error');
          }
        };
        
        reader.readAsText(file);
      });
      
      // Modal close buttons
      document.getElementById('closeTradeModal').addEventListener('click', () => closeModal('tradeModal'));
      document.getElementById('closeImportModal').addEventListener('click', () => closeModal('importModal'));
      
      // Close modal when clicking overlay
      document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal(modal.id);
          }
        });
      });
    });

    // Handle iOS viewport height
    function setVH() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }

    setVH();
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', setVH);
  </script>
</body>
</html>
