<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>Trade Journal Mobile</title>
  <link href="https://fonts.cdnfonts.com/css/trade-gothic-next" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  
  <style>
    /* POLICE ET VARIABLES MOBILE */
    :root {
      --font-primary: 'Trade Gothic Next', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      
      --bg: #000000;
      --bg-card: #1A1A1A;
      --fg: #FFFFFF;
      --muted: #8E8E93;
      --accent-green: #00C48C;
      --accent-red: #FF5C63;
      --accent-blue: #007AFF;
      --accent-purple: #8B5CF6;
      --glass: rgba(30, 30, 30, 0.95);
      --card-bg: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      --border: rgba(255,255,255,0.15);
      --shadow: 0 4px 12px rgba(0,0,0,0.5);
      --overlay: rgba(0,0,0,0.8);
      
      /* Tailles mobiles */
      --safe-area-inset-top: env(safe-area-inset-top);
      --safe-area-inset-bottom: env(safe-area-inset-bottom);
      --safe-area-inset-left: env(safe-area-inset-left);
      --safe-area-inset-right: env(safe-area-inset-right);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--fg);
      font-family: var(--font-primary);
      font-size: 14px;
      line-height: 1.4;
      overflow: hidden;
      position: fixed;
      width: 100%;
    }

    /* APP LAYOUT MOBILE */
    .app {
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-area-inset-top);
      padding-bottom: var(--safe-area-inset-bottom);
      background: var(--bg);
    }

    /* HEADER MOBILE */
    .header {
      padding: 12px 16px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    /* BOTTOM NAVIGATION */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 8px 16px;
      padding-bottom: calc(8px + var(--safe-area-inset-bottom));
      display: flex;
      justify-content: space-around;
      z-index: 1000;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 10px;
      min-width: 60px;
    }

    .nav-item.active {
      color: var(--accent-green);
    }

    .nav-icon {
      font-size: 20px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      padding-bottom: 80px; /* Espace pour la bottom nav */
    }

    /* CARTES MOBILE */
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
    }

    /* TRADES LIST MOBILE */
    .trades-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .trade-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--glass);
      border-radius: 10px;
      border-left: 4px solid transparent;
    }

    .trade-item.win {
      border-left-color: var(--accent-green);
      background: linear-gradient(90deg, rgba(0,196,140,0.1), transparent);
    }

    .trade-item.loss {
      border-left-color: var(--accent-red);
      background: linear-gradient(90deg, rgba(255,92,99,0.08), transparent);
    }

    .trade-symbol {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 2px;
    }

    .trade-details {
      font-size: 12px;
      color: var(--muted);
    }

    .trade-pnl {
      text-align: right;
    }

    .trade-amount {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 2px;
    }

    .trade-percent {
      font-size: 12px;
      color: var(--muted);
    }

    /* METRICS GRID MOBILE */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .metric-card {
      background: var(--card-bg);
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .metric-value {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--muted);
    }

    .metric-positive {
      color: var(--accent-green);
    }

    .metric-negative {
      color: var(--accent-red);
    }

    /* BOUTONS MOBILE */
    .btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 14px 16px;
      border-radius: 12px;
      color: var(--fg);
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      width: 100%;
      margin-bottom: 8px;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent-green), #00E095);
      color: #000000;
      border: none;
      font-weight: 600;
    }

    .btn-small {
      padding: 10px 12px;
      font-size: 14px;
    }

    /* FORMULAIRES MOBILE */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 14px;
      border-radius: 10px;
      color: var(--fg);
      font-size: 16px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-green);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* MODALS MOBILE */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--overlay);
      display: none;
      align-items: flex-end;
      z-index: 2000;
      backdrop-filter: blur(10px);
    }

    .modal {
      width: 100%;
      background: var(--bg-card);
      border-radius: 20px 20px 0 0;
      padding: 20px;
      padding-bottom: calc(20px + var(--safe-area-inset-bottom));
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    /* TOAST MOBILE */
    .toast-container {
      position: fixed;
      top: 20px;
      left: 16px;
      right: 16px;
      z-index: 3000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      padding: 14px 16px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInDown 0.3s ease;
      backdrop-filter: blur(20px);
    }

    .toast.success {
      border-left: 4px solid var(--accent-green);
    }

    .toast.error {
      border-left: 4px solid var(--accent-red);
    }

    .toast.fade-out {
      animation: slideOutUp 0.3s ease forwards;
    }

    @keyframes slideInDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes slideOutUp {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-100%); opacity: 0; }
    }

    /* QUICK ACTIONS */
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    /* CHART MOBILE */
    .chart-container {
      height: 200px;
      margin: 16px 0;
      position: relative;
    }

    /* SWIPE INDICATOR */
    .swipe-indicator {
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 8px;
    }

    /* LOADING STATES */
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* UTILITY CLASSES */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-muted { color: var(--muted); }
    .text-small { font-size: 12px; }
    .text-large { font-size: 18px; }
    .text-xlarge { font-size: 24px; }
    .font-bold { font-weight: 700; }
    .mb-8 { margin-bottom: 8px; }
    .mb-12 { margin-bottom: 12px; }
    .mb-16 { margin-bottom: 16px; }
    .hidden { display: none; }

    /* PULL TO REFRESH */
    .pull-indicator {
      text-align: center;
      padding: 10px;
      color: var(--muted);
    }

    /* SCROLLBAR HIDDEN */
    .main-content::-webkit-scrollbar {
      display: none;
    }

    .main-content {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <div class="app">
    <!-- HEADER -->
    <header class="header">
      <div class="header-content">
        <div class="header-title" id="viewTitle">Tableau de bord</div>
        <div class="header-actions">
          <button class="btn btn-small" id="syncButton">🔄</button>
          <button class="btn btn-small" id="themeToggle">🌓</button>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="main-content" id="mainContent">
      
      <!-- VUE TABLEAU DE BORD -->
      <div id="dashboardView">
        <!-- Carte Capital -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Capital & Performance</div>
          </div>
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value">€ <span id="capitalDisplay">--</span></div>
              <div class="metric-label">Capital</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="winrate">0%</div>
              <div class="metric-label">Win Rate</div>
            </div>
          </div>
          
          <div class="chart-container">
            <canvas id="equityChart"></canvas>
          </div>
        </div>

        <!-- Actions Rapides -->
        <div class="quick-actions">
          <button class="btn primary" id="quickTradeBtn">+ Trade</button>
          <button class="btn" id="importBtn">📥 Import</button>
        </div>

        <!-- Métriques Clés -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Métriques Clés</div>
          </div>
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value" id="profitFactor">--</div>
              <div class="metric-label">Profit Factor</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="maxDrawdown">--</div>
              <div class="metric-label">Max Drawdown</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="expectancy">--</div>
              <div class="metric-label">Expectancy</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="tradesPerMonth">--</div>
              <div class="metric-label">Trades/Mois</div>
            </div>
          </div>
        </div>

        <!-- Trades Récents -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Trades Récents</div>
            <button class="btn btn-small" id="viewAllTradesBtn">Voir tout</button>
          </div>
          <div class="trades-list" id="recentTradesList">
            <!-- Trades insérés par JS -->
          </div>
        </div>
      </div>

      <!-- VUE TRADES -->
      <div id="tradesView" class="hidden">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Tous les Trades</div>
            <button class="btn btn-small" id="exportTradesBtn">Exporter</button>
          </div>
          <div class="trades-list" id="allTradesList">
            <!-- Trades insérés par JS -->
          </div>
        </div>
      </div>

      <!-- VUE ANALYTICS -->
      <div id="analyticsView" class="hidden">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Analyses Détaillées</div>
          </div>
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value" id="analyticsWinrate">--</div>
              <div class="metric-label">Win Rate</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="avgWinLossRatio">--</div>
              <div class="metric-label">Ratio G/P</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="sharpeRatio">--</div>
              <div class="metric-label">Sharpe</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="bestWinStreak">--</div>
              <div class="metric-label">Best Streak</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Performance par Symbole</div>
          </div>
          <div class="chart-container">
            <canvas id="symbolChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Distribution P&L</div>
          </div>
          <div class="chart-container">
            <canvas id="distributionChart"></canvas>
          </div>
        </div>
      </div>

      <!-- VUE COMPTE -->
      <div id="accountView" class="hidden">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Mon Compte</div>
          </div>
          
          <div id="guestView">
            <div class="text-center mb-16">
              <div class="text-muted mb-8">Connectez-vous pour synchroniser vos données</div>
              <button class="btn primary mb-8" id="loginBtn">Se connecter</button>
              <button class="btn" id="signupBtn">Créer un compte</button>
            </div>
          </div>

          <div id="userView" class="hidden">
            <div class="text-center mb-16">
              <div class="font-bold mb-4" id="userEmail"></div>
              <div class="text-muted text-small mb-12" id="lastSync"></div>
              <button class="btn" id="logoutBtn">Déconnexion</button>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Capital Initial</label>
            <input type="number" class="form-input" id="capitalInput" placeholder="10000">
          </div>

          <button class="btn primary" id="saveCapitalBtn">Sauvegarder</button>
        </div>
      </div>

    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
      <button class="nav-item active" data-view="dashboard">
        <div class="nav-icon">📊</div>
        <div>Dashboard</div>
      </button>
      <button class="nav-item" data-view="trades">
        <div class="nav-icon">📈</div>
        <div>Trades</div>
      </button>
      <button class="nav-item" data-view="analytics">
        <div class="nav-icon">📉</div>
        <div>Analytics</div>
      </button>
      <button class="nav-item" data-view="account">
        <div class="nav-icon">👤</div>
        <div>Compte</div>
      </button>
    </nav>
  </div>

  <!-- MODAL NOUVEAU TRADE -->
  <div class="modal-backdrop" id="tradeModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Nouveau Trade</div>
        <button class="btn btn-small" id="closeTradeModal">✕</button>
      </div>
      
      <form id="tradeForm">
        <div class="form-group">
          <label class="form-label">Symbole</label>
          <input type="text" class="form-input" id="symbolInput" placeholder="BTC, ETH..." required>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Side</label>
            <select class="form-input" id="sideInput">
              <option value="long">Long</option>
              <option value="short">Short</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Size</label>
            <input type="number" class="form-input" id="sizeInput" value="1" step="0.1" required>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Entry Price</label>
            <input type="number" class="form-input" id="entryInput" step="0.01" required>
          </div>
          <div class="form-group">
            <label class="form-label">Exit Price</label>
            <input type="number" class="form-input" id="exitInput" step="0.01">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Fees</label>
            <input type="number" class="form-input" id="feesInput" value="0" step="0.01">
          </div>
          <div class="form-group">
            <label class="form-label">Taxes</label>
            <input type="number" class="form-input" id="taxesInput" value="0" step="0.01">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Commentaire</label>
          <textarea class="form-input" id="commentInput" placeholder="Notes..."></textarea>
        </div>

        <button type="submit" class="btn primary">Enregistrer le Trade</button>
      </form>
    </div>
  </div>

  <!-- MODAL AUTHENTIFICATION -->
  <div class="modal-backdrop" id="authModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="authTitle">Connexion</div>
        <button class="btn btn-small" id="closeAuthModal">✕</button>
      </div>
      
      <form id="authForm">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="authEmail" required>
        </div>

        <div class="form-group">
          <label class="form-label">Mot de passe</label>
          <input type="password" class="form-input" id="authPassword" required>
        </div>

        <div class="form-group" id="confirmPasswordGroup" style="display: none;">
          <label class="form-label">Confirmer le mot de passe</label>
          <input type="password" class="form-input" id="confirmPassword">
        </div>

        <button type="submit" class="btn primary" id="authSubmit">Se connecter</button>
      </form>

      <div class="text-center mt-16">
        <div class="text-muted text-small" id="authMessage"></div>
        <div class="text-muted text-small mt-8">
          <span id="authSwitchText">Pas de compte ? </span>
          <button class="btn btn-small" id="authSwitchBtn">S'inscrire</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURATION FIREBASE ==========
    const firebaseConfig = {
      apiKey: "AIzaSyDGfiBOOEZiLZmh7clQlSZAr1W6P6Si8vM",
      authDomain: "journaltrading-a6bc6.firebaseapp.com",
      projectId: "journaltrading-a6bc6",
      storageBucket: "journaltrading-a6bc6.firebasestorage.app",
      messagingSenderId: "220303277331",
      appId: "1:220303277331:web:f4251eebd62d3058f82ee6",
      measurementId: "G-8EEHYVXQS6"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ========== ÉTAT GLOBAL ==========
    const AppState = {
      trades: [],
      capital: 10000,
      currentUser: null,
      
      getStorageKey() {
        const userId = this.currentUser ? this.currentUser.uid : 'guest';
        return `mobile_trades_${userId}`;
      },
      
      getCapitalKey() {
        const userId = this.currentUser ? this.currentUser.uid : 'guest';
        return `mobile_capital_${userId}`;
      },
      
      init() {
        this.loadFromLocal();
      },
      
      loadFromLocal() {
        try {
          const storageKey = this.getStorageKey();
          const capitalKey = this.getCapitalKey();
          
          const storedTrades = localStorage.getItem(storageKey);
          const storedCapital = localStorage.getItem(capitalKey);
          
          this.trades = storedTrades ? JSON.parse(storedTrades) : [];
          this.capital = storedCapital ? parseFloat(storedCapital) : 10000;
          this.trades = this.trades.filter(t => t && t.id && t.symbol);
        } catch (error) {
          console.error('Error loading data:', error);
          this.trades = [];
          this.capital = 10000;
        }
      },
      
      persistToLocal() {
        try {
          const storageKey = this.getStorageKey();
          const capitalKey = this.getCapitalKey();
          
          localStorage.setItem(storageKey, JSON.stringify(this.trades));
          localStorage.setItem(capitalKey, this.capital.toString());
          return true;
        } catch (error) {
          console.error('Error saving data:', error);
          return false;
        }
      },
      
      async syncToCloud() {
        if (!this.currentUser) return false;
        
        try {
          let successCount = 0;
          
          for (const trade of this.trades) {
            try {
              const tradeData = {
                id: trade.id,
                symbol: trade.symbol,
                side: trade.side,
                entry_price: Number(trade.entry_price),
                exit_price: trade.exit_price ? Number(trade.exit_price) : null,
                size: Number(trade.size),
                fees: Number(trade.fees || 0),
                taxes: Number(trade.taxes || 0),
                entry_timestamp: trade.entry_timestamp || new Date().toISOString(),
                exit_timestamp: trade.exit_timestamp || null,
                comment: trade.comment || '',
                userId: this.currentUser.uid,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const tradeRef = db.collection('trades').doc(trade.id);
              await tradeRef.set(tradeData, { merge: true });
              successCount++;
              
            } catch (error) {
              console.error('Error syncing trade:', error);
            }
          }
          
          return successCount > 0;
        } catch (error) {
          console.error('Sync error:', error);
          return false;
        }
      },
      
      async loadFromCloud() {
        if (!this.currentUser) return false;
        
        try {
          const snapshot = await db.collection('trades')
            .where('userId', '==', this.currentUser.uid)
            .orderBy('updated_at', 'desc')
            .get();
          
          if (snapshot.empty) return true;
          
          const cloudTrades = [];
          snapshot.forEach(doc => {
            cloudTrades.push(doc.data());
          });
          
          // Fusion simple - le cloud écrase le local
          this.trades = cloudTrades;
          this.persistToLocal();
          return true;
          
        } catch (error) {
          console.error('Load from cloud error:', error);
          return false;
        }
      }
    };

    // ========== FONCTIONS UTILITAIRES ==========
    function showToast(message, type = 'info', duration = 3000) {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      toast.innerHTML = `
        <div>${type === 'success' ? '✅' : type === 'error' ? '❌' : '💡'}</div>
        <div>${message}</div>
      `;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    function cryptoRandomId() { 
      return 'm_' + Math.random().toString(36).slice(2, 10) + '_' + Date.now().toString(36); 
    }

    function computePnL(trade) { 
      if (!trade.exit_price || !trade.entry_price || !trade.size) return null;
      
      let pnl;
      if (trade.side === 'long') {
        pnl = (trade.exit_price - trade.entry_price) * trade.size - (trade.fees || 0) - (trade.taxes || 0);
      } else {
        pnl = (trade.entry_price - trade.exit_price) * trade.size - (trade.fees || 0) - (trade.taxes || 0);
      }
      return parseFloat(pnl.toFixed(2));
    }

    function calculateMetrics() {
      const closed = AppState.trades.filter(t => computePnL(t) !== null);
      const wins = closed.filter(t => computePnL(t) > 0);
      
      // Win Rate
      const winrate = closed.length ? ((wins.length / closed.length) * 100).toFixed(1) + '%' : '0%';
      
      // Profit Factor
      const totalProfit = wins.reduce((sum, t) => sum + computePnL(t), 0);
      const totalLoss = Math.abs(closed.filter(t => computePnL(t) < 0).reduce((sum, t) => sum + computePnL(t), 0));
      const profitFactor = totalLoss > 0 ? (totalProfit / totalLoss).toFixed(2) : totalProfit > 0 ? '∞' : '0';
      
      // Max Drawdown
      let maxDrawdown = 0;
      let peak = AppState.capital;
      let equity = AppState.capital;
      
      closed.sort((a, b) => new Date(a.exit_timestamp || a.entry_timestamp) - new Date(b.exit_timestamp || b.entry_timestamp));
      
      closed.forEach(trade => {
        equity += computePnL(trade);
        if (equity > peak) peak = equity;
        const drawdown = ((peak - equity) / peak) * 100;
        if (drawdown > maxDrawdown) maxDrawdown = drawdown;
      });
      
      // Expectancy
      const avgWin = wins.length > 0 ? totalProfit / wins.length : 0;
      const avgLoss = closed.length - wins.length > 0 ? totalLoss / (closed.length - wins.length) : 0;
      const expectancy = (avgWin * (wins.length / closed.length)) - (avgLoss * ((closed.length - wins.length) / closed.length));
      
      // Trades par mois
      const tradesByMonth = {};
      AppState.trades.forEach(trade => {
        const date = new Date(trade.entry_timestamp);
        const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
        tradesByMonth[monthKey] = (tradesByMonth[monthKey] || 0) + 1;
      });
      const tradesPerMonth = (Object.values(tradesByMonth).reduce((a, b) => a + b, 0) / Math.max(Object.keys(tradesByMonth).length, 1)).toFixed(1);
      
      // Ratio G/P
      const avgWinLossRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '∞' : '0';
      
      // Sharpe Ratio simplifié
      const returns = closed.map(t => computePnL(t) / (t.entry_price * t.size));
      const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
      const stdDev = Math.sqrt(returns.map(r => Math.pow(r - avgReturn, 2)).reduce((a, b) => a + b, 0) / returns.length);
      const sharpeRatio = stdDev > 0 ? (avgReturn / stdDev).toFixed(2) : '0';
      
      // Best win streak
      let currentStreak = 0;
      let bestStreak = 0;
      closed.forEach(trade => {
        if (computePnL(trade) > 0) {
          currentStreak++;
          bestStreak = Math.max(bestStreak, currentStreak);
        } else {
          currentStreak = 0;
        }
      });
      
      return {
        winrate,
        profitFactor,
        maxDrawdown: maxDrawdown.toFixed(1) + '%',
        expectancy: expectancy.toFixed(2),
        tradesPerMonth,
        avgWinLossRatio,
        sharpeRatio,
        bestWinStreak: bestStreak
      };
    }

    // ========== RENDU UI ==========
    function renderTrades() {
      const recentList = document.getElementById('recentTradesList');
      const allList = document.getElementById('allTradesList');
      
      const recentTrades = AppState.trades.slice(0, 10);
      const allTrades = AppState.trades;
      
      function createTradeElement(trade) {
        const pnl = computePnL(trade);
        const element = document.createElement('div');
        element.className = `trade-item ${pnl > 0 ? 'win' : pnl < 0 ? 'loss' : ''}`;
        element.onclick = () => openTradeModal(trade);
        
        element.innerHTML = `
          <div>
            <div class="trade-symbol">${trade.symbol}</div>
            <div class="trade-details">${trade.side} • ${trade.size} @ ${trade.entry_price}</div>
          </div>
          <div class="trade-pnl">
            <div class="trade-amount">${pnl === null ? 'OUVERT' : (pnl >= 0 ? '+' : '') + pnl.toFixed(2)} €</div>
            <div class="trade-percent">${pnl ? ((pnl / (trade.entry_price * trade.size)) * 100).toFixed(2) + '%' : ''}</div>
          </div>
        `;
        
        return element;
      }
      
      // Rendre les trades récents
      recentList.innerHTML = '';
      if (recentTrades.length === 0) {
        recentList.innerHTML = '<div class="text-center text-muted">Aucun trade</div>';
      } else {
        recentTrades.forEach(trade => {
          recentList.appendChild(createTradeElement(trade));
        });
      }
      
      // Rendre tous les trades
      allList.innerHTML = '';
      if (allTrades.length === 0) {
        allList.innerHTML = '<div class="text-center text-muted">Aucun trade</div>';
      } else {
        allTrades.forEach(trade => {
          allList.appendChild(createTradeElement(trade));
        });
      }
    }
    
    function renderMetrics() {
      const metrics = calculateMetrics();
      const capital = AppState.capital + AppState.trades
        .filter(t => computePnL(t) !== null)
        .reduce((sum, t) => sum + computePnL(t), 0);
      
      // Mettre à jour les métriques de base
      document.getElementById('capitalDisplay').textContent = capital.toFixed(2);
      document.getElementById('winrate').textContent = metrics.winrate;
      
      // Métriques avancées
      document.getElementById('profitFactor').textContent = metrics.profitFactor;
      document.getElementById('maxDrawdown').textContent = metrics.maxDrawdown;
      document.getElementById('expectancy').textContent = metrics.expectancy;
      document.getElementById('tradesPerMonth').textContent = metrics.tradesPerMonth;
      
      // Métriques analytics
      document.getElementById('analyticsWinrate').textContent = metrics.winrate;
      document.getElementById('avgWinLossRatio').textContent = metrics.avgWinLossRatio;
      document.getElementById('sharpeRatio').textContent = metrics.sharpeRatio;
      document.getElementById('bestWinStreak').textContent = metrics.bestWinStreak;
    }
    
    function renderUserInfo() {
      const guestView = document.getElementById('guestView');
      const userView = document.getElementById('userView');
      
      if (AppState.currentUser) {
        guestView.classList.add('hidden');
        userView.classList.remove('hidden');
        document.getElementById('userEmail').textContent = AppState.currentUser.email;
        document.getElementById('lastSync').textContent = 'Dernière sync: ' + new Date().toLocaleTimeString();
      } else {
        guestView.classList.remove('hidden');
        userView.classList.add('hidden');
      }
    }
    
    function renderAll() {
      renderTrades();
      renderMetrics();
      renderUserInfo();
      updateChart();
      initAnalyticsCharts();
    }

    // ========== GRAPHIQUES ==========
    let equityChart = null;
    let symbolChart = null;
    let distributionChart = null;
    
    function initChart() {
      const ctx = document.getElementById('equityChart');
      if (!ctx) return;
      
      equityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Equity',
            data: [],
            borderColor: '#00C48C',
            backgroundColor: 'rgba(0, 196, 140, 0.1)',
            fill: true,
            tension: 0.4,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: { display: false }
          },
          interaction: { intersect: false },
          elements: { point: { radius: 0 } }
        }
      });
    }
    
    function updateChart() {
      if (!equityChart) return;
      
      const closed = AppState.trades.filter(t => computePnL(t) !== null)
        .sort((a, b) => new Date(a.exit_timestamp || a.entry_timestamp) - new Date(b.exit_timestamp || b.entry_timestamp));
      
      let equity = AppState.capital;
      const data = [equity];
      
      closed.forEach(trade => {
        equity += computePnL(trade);
        data.push(equity);
      });
      
      equityChart.data.labels = Array(data.length).fill('');
      equityChart.data.datasets[0].data = data;
      equityChart.update();
    }
    
    function initAnalyticsCharts() {
      // Chart Performance par Symbole
      const symbolCtx = document.getElementById('symbolChart');
      if (symbolCtx && !symbolChart) {
        const closed = AppState.trades.filter(t => computePnL(t) !== null);
        const symbolData = {};
        
        closed.forEach(trade => {
          if (!symbolData[trade.symbol]) symbolData[trade.symbol] = 0;
          symbolData[trade.symbol] += computePnL(trade);
        });
        
        const symbols = Object.keys(symbolData).slice(0, 8);
        const profits = symbols.map(symbol => symbolData[symbol]);
        
        symbolChart = new Chart(symbolCtx, {
          type: 'bar',
          data: {
            labels: symbols,
            datasets: [{
              data: profits,
              backgroundColor: profits.map(p => p >= 0 ? '#00C48C' : '#FF5C63')
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { display: false }
            }
          }
        });
      }
      
      // Chart Distribution P&L
      const distCtx = document.getElementById('distributionChart');
      if (distCtx && !distributionChart) {
        const closed = AppState.trades.filter(t => computePnL(t) !== null);
        const pnls = closed.map(t => computePnL(t));
        
        if (pnls.length > 0) {
          distributionChart = new Chart(distCtx, {
            type: 'bar',
            data: {
              labels: ['Perte', 'Neutre', 'Gain'],
              datasets: [{
                data: [
                  pnls.filter(p => p < 0).length,
                  pnls.filter(p => p === 0).length,
                  pnls.filter(p => p > 0).length
                ],
                backgroundColor: ['#FF5C63', '#8E8E93', '#00C48C']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { display: false },
                y: { display: false }
              }
            }
          });
        }
      }
    }

    // ========== GESTION DES VUES ==========
    function showView(viewName) {
      // Cacher toutes les vues
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('tradesView').classList.add('hidden');
      document.getElementById('analyticsView').classList.add('hidden');
      document.getElementById('accountView').classList.add('hidden');
      
      // Afficher la vue sélectionnée
      document.getElementById(viewName + 'View').classList.remove('hidden');
      
      // Mettre à jour le titre
      const titles = {
        dashboard: 'Tableau de bord',
        trades: 'Mes Trades',
        analytics: 'Analytics',
        account: 'Mon Compte'
      };
      document.getElementById('viewTitle').textContent = titles[viewName];
      
      // Mettre à jour la navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
    }

    // ========== GESTION DES MODALS ==========
    function openTradeModal(trade = null) {
      const modal = document.getElementById('tradeModal');
      const form = document.getElementById('tradeForm');
      
      if (trade) {
        // Mode édition
        document.getElementById('symbolInput').value = trade.symbol;
        document.getElementById('sideInput').value = trade.side;
        document.getElementById('sizeInput').value = trade.size;
        document.getElementById('entryInput').value = trade.entry_price;
        document.getElementById('exitInput').value = trade.exit_price || '';
        document.getElementById('feesInput').value = trade.fees || 0;
        document.getElementById('taxesInput').value = trade.taxes || 0;
        document.getElementById('commentInput').value = trade.comment || '';
        
        form.dataset.editId = trade.id;
      } else {
        // Mode création
        form.reset();
        delete form.dataset.editId;
        document.getElementById('exitInput').value = '';
      }
      
      modal.style.display = 'flex';
    }
    
    function openAuthModal(isSignup = false) {
      const modal = document.getElementById('authModal');
      const title = document.getElementById('authTitle');
      const submitBtn = document.getElementById('authSubmit');
      const confirmGroup = document.getElementById('confirmPasswordGroup');
      const switchText = document.getElementById('authSwitchText');
      const switchBtn = document.getElementById('authSwitchBtn');
      
      if (isSignup) {
        title.textContent = 'Créer un compte';
        submitBtn.textContent = 'S\'inscrire';
        confirmGroup.style.display = 'block';
        switchText.textContent = 'Déjà un compte ? ';
        switchBtn.textContent = 'Se connecter';
      } else {
        title.textContent = 'Connexion';
        submitBtn.textContent = 'Se connecter';
        confirmGroup.style.display = 'none';
        switchText.textContent = 'Pas de compte ? ';
        switchBtn.textContent = 'S\'inscrire';
      }
      
      modal.style.display = 'flex';
    }

    // ========== AUTHENTIFICATION ==========
    async function signUp(email, password) {
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        return { success: true, user: userCredential.user };
      } catch (error) {
        return { success: false, error: error.message };
      }
    }
    
    async function signIn(email, password) {
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        return { success: true, user: userCredential.user };
      } catch (error) {
        return { success: false, error: error.message };
      }
    }
    
    async function signOut() {
      try {
        await auth.signOut();
        AppState.currentUser = null;
        AppState.loadFromLocal();
        renderAll();
        showToast('Déconnexion réussie', 'success');
      } catch (error) {
        showToast('Erreur de déconnexion', 'error');
      }
    }
    
    function checkAuth() {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          AppState.currentUser = user;
          await AppState.loadFromCloud();
          showToast(`Bienvenue ${user.email}`, 'success');
        } else {
          AppState.currentUser = null;
          AppState.loadFromLocal();
        }
        renderAll();
      });
    }

    // ========== ÉVÉNEMENTS ==========
    document.addEventListener('DOMContentLoaded', function() {
      // Initialiser l'application
      AppState.init();
      initChart();
      checkAuth();
      renderAll();
      
      // Navigation bottom
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const view = item.dataset.view;
          showView(view);
        });
      });
      
      // Actions rapides
      document.getElementById('quickTradeBtn').addEventListener('click', () => openTradeModal());
      document.getElementById('viewAllTradesBtn').addEventListener('click', () => showView('trades'));
      document.getElementById('exportTradesBtn').addEventListener('click', exportTrades);
      document.getElementById('importBtn').addEventListener('click', importTrades);
      
      // Gestion compte
      document.getElementById('loginBtn').addEventListener('click', () => openAuthModal(false));
      document.getElementById('signupBtn').addEventListener('click', () => openAuthModal(true));
      document.getElementById('logoutBtn').addEventListener('click', signOut);
      document.getElementById('saveCapitalBtn').addEventListener('click', saveCapital);
      document.getElementById('syncButton').addEventListener('click', forceSync);
      
      // Formulaire trade
      document.getElementById('tradeForm').addEventListener('submit', saveTrade);
      document.getElementById('closeTradeModal').addEventListener('click', () => {
        document.getElementById('tradeModal').style.display = 'none';
      });
      
      // Formulaire auth
      document.getElementById('authForm').addEventListener('submit', handleAuth);
      document.getElementById('authSwitchBtn').addEventListener('click', () => {
        const isSignup = document.getElementById('authTitle').textContent === 'Connexion';
        openAuthModal(isSignup);
      });
      document.getElementById('closeAuthModal').addEventListener('click', () => {
        document.getElementById('authModal').style.display = 'none';
      });
      
      // Fermer les modals en cliquant à l'extérieur
      document.querySelectorAll('.modal-backdrop').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
      
      // Thème
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    });
    
    async function saveTrade(e) {
      e.preventDefault();
      
      const form = e.target;
      const trade = {
        symbol: document.getElementById('symbolInput').value.toUpperCase(),
        side: document.getElementById('sideInput').value,
        size: parseFloat(document.getElementById('sizeInput').value),
        entry_price: parseFloat(document.getElementById('entryInput').value),
        exit_price: document.getElementById('exitInput').value ? parseFloat(document.getElementById('exitInput').value) : null,
        fees: parseFloat(document.getElementById('feesInput').value),
        taxes: parseFloat(document.getElementById('taxesInput').value),
        comment: document.getElementById('commentInput').value,
        entry_timestamp: new Date().toISOString()
      };
      
      if (form.dataset.editId) {
        // Édition
        const index = AppState.trades.findIndex(t => t.id === form.dataset.editId);
        if (index !== -1) {
          trade.id = form.dataset.editId;
          AppState.trades[index] = trade;
        }
      } else {
        // Nouveau trade
        trade.id = cryptoRandomId();
        AppState.trades.unshift(trade);
      }
      
      await AppState.persistToLocal();
      if (AppState.currentUser) {
        await AppState.syncToCloud();
      }
      
      renderAll();
      document.getElementById('tradeModal').style.display = 'none';
      showToast('Trade enregistré', 'success');
    }
    
    async function handleAuth(e) {
      e.preventDefault();
      
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const isSignup = document.getElementById('authTitle').textContent === 'Créer un compte';
      
      let result;
      if (isSignup) {
        const confirmPassword = document.getElementById('confirmPassword').value;
        if (password !== confirmPassword) {
          document.getElementById('authMessage').textContent = 'Les mots de passe ne correspondent pas';
          return;
        }
        result = await signUp(email, password);
      } else {
        result = await signIn(email, password);
      }
      
      if (result.success) {
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('authForm').reset();
        showToast(isSignup ? 'Compte créé !' : 'Connecté !', 'success');
      } else {
        document.getElementById('authMessage').textContent = result.error;
      }
    }
    
    function saveCapital() {
      const capital = parseFloat(document.getElementById('capitalInput').value);
      if (!isNaN(capital) && capital > 0) {
        AppState.capital = capital;
        AppState.persistToLocal();
        renderAll();
        showToast('Capital sauvegardé', 'success');
      }
    }
    
    async function forceSync() {
      if (!AppState.currentUser) {
        showToast('Connectez-vous pour synchroniser', 'error');
        return;
      }
      
      showToast('Synchronisation...', 'info');
      const success = await AppState.syncToCloud();
      showToast(success ? 'Sync réussie' : 'Erreur sync', success ? 'success' : 'error');
    }
    
    function exportTrades() {
      const data = JSON.stringify(AppState.trades, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `trades_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Trades exportés', 'success');
    }
    
    function importTrades() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const trades = JSON.parse(e.target.result);
            AppState.trades = [...trades, ...AppState.trades];
            AppState.persistToLocal();
            renderAll();
            showToast(`${trades.length} trades importés`, 'success');
          } catch (error) {
            showToast('Erreur import', 'error');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    }
    
    function toggleTheme() {
      const isDark = document.documentElement.style.getPropertyValue('--bg') === '#000000' || 
                    !document.documentElement.style.getPropertyValue('--bg');
      
      if (isDark) {
        // Passer en light
        document.documentElement.style.setProperty('--bg', '#FFFFFF');
        document.documentElement.style.setProperty('--bg-card', '#F8F9FA');
        document.documentElement.style.setProperty('--fg', '#1A1A1A');
        document.documentElement.style.setProperty('--muted', '#666666');
        document.documentElement.style.setProperty('--border', 'rgba(0,0,0,0.15)');
      } else {
        // Passer en dark
        document.documentElement.style.setProperty('--bg', '#000000');
        document.documentElement.style.setProperty('--bg-card', '#1A1A1A');
        document.documentElement.style.setProperty('--fg', '#FFFFFF');
        document.documentElement.style.setProperty('--muted', '#8E8E93');
        document.documentElement.style.setProperty('--border', 'rgba(255,255,255,0.15)');
      }
    }

    // Gestion du swipe pour navigation
    let startX = 0;
    document.getElementById('mainContent').addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
    });
    
    document.getElementById('mainContent').addEventListener('touchend', (e) => {
      const endX = e.changedTouches[0].clientX;
      const diff = startX - endX;
      
      if (Math.abs(diff) > 50) { // Seuil de swipe
        const views = ['dashboard', 'trades', 'analytics', 'account'];
        const currentView = document.querySelector('.nav-item.active').dataset.view;
        const currentIndex = views.indexOf(currentView);
        
        if (diff > 0 && currentIndex < views.length - 1) {
          // Swipe gauche -> droite
          showView(views[currentIndex + 1]);
        } else if (diff < 0 && currentIndex > 0) {
          // Swipe droite -> gauche
          showView(views[currentIndex - 1]);
        }
      }
    });

    // Pull to refresh
    let startY = 0;
    document.getElementById('mainContent').addEventListener('touchstart', (e) => {
      startY = e.touches[0].clientY;
    });
    
    document.getElementById('mainContent').addEventListener('touchmove', (e) => {
      const currentY = e.touches[0].clientY;
      const diff = currentY - startY;
      
      if (diff > 100 && window.scrollY === 0) {
        // Pull to refresh
        renderAll();
        showToast('Actualisé', 'success');
      }
    });
  </script>
</body>
</html>
