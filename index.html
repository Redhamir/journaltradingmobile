<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Journal Mobile</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #00C48C;
            --primary-dark: #00A876;
            --danger: #FF5C63;
            --warning: #FFA726;
            --info: #2196F3;
            --purple: #9C27B0;
            
            --bg-primary: #0A0A0A;
            --bg-secondary: #1A1A1A;
            --bg-card: #2A2A2A;
            
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0A0;
            --text-muted: #666666;
            
            --border: rgba(255,255,255,0.1);
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
            
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        [data-theme="light"] {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F9FA;
            --bg-card: #FFFFFF;
            
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --text-muted: #A0A0A0;
            
            --border: rgba(0,0,0,0.1);
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            padding-top: var(--safe-area-top);
            padding-bottom: var(--safe-area-bottom);
        }

        /* √âcran de connexion */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 3000;
        }

        .login-container {
            width: 100%;
            max-width: 400px;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-logo i {
            font-size: 64px;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .login-logo h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-logo p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .login-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            min-height: 44px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            color: var(--text-secondary);
            position: relative;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border);
        }

        .auth-divider span {
            background: var(--bg-card);
            padding: 0 16px;
            position: relative;
        }

        .btn-google {
            background: white;
            color: #333;
            border: 1px solid var(--border);
        }

        .btn-anonymous {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* Toast System */
        .toast-container {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            z-index: 10000;
            padding: 0 16px;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .toast.success { border-left: 4px solid var(--primary); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.info { border-left: 4px solid var(--info); }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Header Mobile */
        .header {
            position: fixed;
            top: var(--safe-area-top);
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            display: none;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--bg-card);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 8px 16px;
            padding-bottom: calc(8px + var(--safe-area-bottom));
            display: flex;
            justify-content: space-around;
            z-index: 1000;
            backdrop-filter: blur(10px);
            display: none;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 10px;
            cursor: pointer;
            border-radius: 12px;
            min-width: 60px;
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(0, 196, 140, 0.1);
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            padding: 80px 0 80px 0;
            min-height: 100vh;
            display: none;
        }

        .page {
            display: none;
            padding: 16px;
        }

        .page.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stats-grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-positive { color: var(--primary); }
        .stat-negative { color: var(--danger); }
        .stat-warning { color: var(--warning); }
        .stat-info { color: var(--info); }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Trade List */
        .trade-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trade-item {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .trade-item:active {
            transform: scale(0.98);
        }

        .trade-item.win {
            border-left: 4px solid var(--primary);
            background: linear-gradient(90deg, rgba(0,196,140,0.1), transparent);
        }

        .trade-item.loss {
            border-left: 4px solid var(--danger);
            background: linear-gradient(90deg, rgba(255,92,99,0.1), transparent);
        }

        .trade-item.open {
            border-left: 4px solid var(--info);
            background: linear-gradient(90deg, rgba(33,150,243,0.1), transparent);
        }

        .trade-main {
            flex: 1;
        }

        .trade-symbol {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .trade-details {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .trade-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .trade-pnl {
            text-align: right;
            font-weight: 600;
            min-width: 100px;
        }

        .trade-pnl.positive { color: var(--primary); }
        .trade-pnl.negative { color: var(--danger); }
        .trade-pnl.neutral { color: var(--text-secondary); }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        /* Modals */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 16px;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .modal-header {
            padding: 20px 20px 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-body {
            padding: 0 20px 20px 20px;
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 24px rgba(0, 196, 140, 0.3);
            cursor: pointer;
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .quick-action {
            flex: 1;
            min-width: 120px;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 200px;
            margin: 16px 0;
        }

        .chart-container-lg {
            height: 250px;
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-card) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .text-small { font-size: 12px; }
        .mb-16 { margin-bottom: 16px; }
        .mt-16 { margin-top: 16px; }
        .hidden { display: none; }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-email {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .tab {
            padding: 12px 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Strategy Tags */
        .strategy-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .strategy-tag {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .strategy-tag.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Rating Stars */
        .rating {
            display: flex;
            gap: 4px;
        }

        .star {
            color: var(--text-muted);
            cursor: pointer;
        }

        .star.active {
            color: var(--warning);
        }

        /* Responsive Adjustments */
        @media (max-width: 360px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
            }
        }

        /* Swipe gestures for navigation */
        .page {
            touch-action: pan-y;
        }
    </style>
</head>
<body>
    <!-- √âcran de Connexion -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-chart-line"></i>
                <h1>Trade Journal</h1>
                <p>G√©rez vos trades en mobile</p>
            </div>
            
            <div class="login-card">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">Connexion</button>
                    <button class="auth-tab" data-tab="signup">Inscription</button>
                </div>
                
                <form class="auth-form" id="authForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="authEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Mot de passe</label>
                        <input type="password" class="form-input" id="authPassword" required minlength="6">
                    </div>
                    
                    <div class="form-group" id="authConfirmGroup" style="display: none;">
                        <label class="form-label">Confirmer le mot de passe</label>
                        <input type="password" class="form-input" id="authConfirmPassword" minlength="6">
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block" id="authSubmit">
                        Se connecter
                    </button>
                </form>
                
                <div class="auth-divider">
                    <span>Ou continuer avec</span>
                </div>
                
                <div class="auth-form">
                    <button type="button" class="btn btn-google btn-block" id="googleLogin">
                        <i class="fab fa-google"></i>
                        Google
                    </button>
                    
                    <button type="button" class="btn btn-anonymous btn-block" id="anonymousLogin">
                        <i class="fas fa-user-secret"></i>
                        Mode Invit√©
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <header class="header" id="appHeader">
        <div class="header-title" id="headerTitle">Tableau de bord</div>
        <div class="header-actions">
            <button class="icon-btn" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <button class="icon-btn" id="syncButton">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="icon-btn" id="logoutButton">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- User Info -->
        <div class="user-info" id="userInfo">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-details">
                <div class="user-name" id="userName">Utilisateur</div>
                <div class="user-email" id="userEmail">email@exemple.com</div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <section id="dashboardPage" class="page active">
            <!-- Positions Ouvertes -->
            <div class="card" id="openPositionsCard" style="display: none;">
                <div class="card-header">
                    <div class="card-title">Positions Ouvertes</div>
                    <div class="text-muted text-small" id="openPositionsCount">0 positions</div>
                </div>
                <div class="trade-list" id="openPositionsList">
                    <!-- Positions ouvertes will be populated by JavaScript -->
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Performance Globale</div>
                </div>
                
                <div class="stats-grid stats-grid-3">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPnl">--</div>
                        <div class="stat-label">P&L Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="winRate">--%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalTrades">0</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sharpeRatio">--</div>
                        <div class="stat-label">Sharpe Ratio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="maxDrawdown">--%</div>
                        <div class="stat-label">Max Drawdown</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profitFactor">--</div>
                        <div class="stat-label">Profit Factor</div>
                    </div>
                </div>

                <div class="chart-container-lg">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Trades R√©cents</div>
                    <button class="btn btn-outline" onclick="showPage('tradesPage')">
                        Voir tout
                    </button>
                </div>
                
                <div class="trade-list" id="recentTradesList">
                    <!-- Trades will be populated by JavaScript -->
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary quick-action" onclick="openTradeModal()">
                    <i class="fas fa-plus"></i>
                    Nouveau Trade
                </button>
                <button class="btn btn-outline quick-action" onclick="showPage('analyticsPage')">
                    <i class="fas fa-chart-bar"></i>
                    Analytics
                </button>
            </div>
        </section>

        <!-- Trades Page -->
        <section id="tradesPage" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Tous les Trades</div>
                    <div class="header-actions">
                        <button class="icon-btn" onclick="exportCSV()" title="Exporter CSV">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="icon-btn" onclick="openTradeModal()" title="Nouveau trade">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Filtres Strat√©gies -->
                <div class="strategy-tags" id="strategyFilters">
                    <!-- Strategy filters will be populated by JavaScript -->
                </div>

                <!-- Tabs pour trades ouverts/ferm√©s -->
                <div class="tabs">
                    <button class="tab active" data-tab="all">Tous</button>
                    <button class="tab" data-tab="open">Ouverts</button>
                    <button class="tab" data-tab="closed">Ferm√©s</button>
                </div>
                
                <div class="trade-list" id="allTradesList">
                    <!-- All trades will be populated by JavaScript -->
                </div>
            </div>
        </section>

        <!-- Analytics Page -->
        <section id="analyticsPage" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Analyses D√©taill√©es</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="analyticsProfitFactor">--</div>
                        <div class="stat-label">Profit Factor</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analyticsMaxDrawdown">--%</div>
                        <div class="stat-label">Max Drawdown</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analyticsBestTrade">--</div>
                        <div class="stat-label">Meilleur Trade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analyticsWorstTrade">--</div>
                        <div class="stat-label">Pire Trade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analyticsSharpe">--</div>
                        <div class="stat-label">Sharpe Ratio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="analyticsSortino">--</div>
                        <div class="stat-label">Sortino Ratio</div>
                    </div>
                </div>

                <div class="chart-container-lg">
                    <canvas id="analyticsChart"></canvas>
                </div>
            </div>

            <!-- Distribution des P&L -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Distribution des P&L</div>
                </div>
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>

            <!-- Performance par Strat√©gie -->
            <div class="card" id="strategyPerformanceCard" style="display: none;">
                <div class="card-header">
                    <div class="card-title">Performance par Strat√©gie</div>
                </div>
                <div class="trade-list" id="strategyPerformanceList">
                    <!-- Strategy performance will be populated by JavaScript -->
                </div>
            </div>
        </section>

        <!-- Settings Page -->
        <section id="settingsPage" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Param√®tres</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Capital Initial</label>
                    <input type="number" class="form-input" id="initialCapital" placeholder="10000">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Devise</label>
                    <select class="form-input" id="currency">
                        <option value="EUR">‚Ç¨ EUR</option>
                        <option value="USD">$ USD</option>
                        <option value="GBP">¬£ GBP</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Taux Sans Risque (pour Sharpe Ratio)</label>
                    <input type="number" class="form-input" id="riskFreeRate" value="2" step="0.1">
                    <div class="text-muted text-small">En pourcentage annuel</div>
                </div>
                
                <button class="btn btn-primary btn-block" onclick="saveSettings()">
                    Sauvegarder
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Gestion des Donn√©es</div>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-outline btn-block" onclick="exportCSV()">
                        <i class="fas fa-download"></i>
                        Exporter les Donn√©es
                    </button>
                </div>
                
                <div class="form-group">
                    <input type="file" id="importFile" accept=".csv" class="hidden">
                    <button class="btn btn-outline btn-block" onclick="document.getElementById('importFile').click()">
                        <i class="fas fa-upload"></i>
                        Importer CSV
                    </button>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-danger btn-block" onclick="clearAllData()">
                        <i class="fas fa-trash"></i>
                        Supprimer Toutes les Donn√©es
                    </button>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" id="bottomNav">
        <button class="nav-item active" onclick="showPage('dashboardPage')">
            <i class="fas fa-chart-line nav-icon"></i>
            Dashboard
        </button>
        <button class="nav-item" onclick="showPage('tradesPage')">
            <i class="fas fa-list nav-icon"></i>
            Trades
        </button>
        <button class="nav-item" onclick="showPage('analyticsPage')">
            <i class="fas fa-chart-bar nav-icon"></i>
            Analytics
        </button>
        <button class="nav-item" onclick="showPage('settingsPage')">
            <i class="fas fa-cog nav-icon"></i>
            R√©glages
        </button>
    </nav>

    <!-- FAB -->
    <button class="fab" id="fabButton" onclick="openTradeModal()">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Trade Modal -->
    <div class="modal-backdrop" id="tradeModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="tradeModalTitle">Nouveau Trade</div>
                <button class="icon-btn" onclick="closeTradeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="tradeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Symbole</label>
                            <input type="text" class="form-input" id="symbol" required placeholder="BTC">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Side</label>
                            <select class="form-input" id="side" required>
                                <option value="long">Long</option>
                                <option value="short">Short</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Prix Entr√©e</label>
                            <input type="number" class="form-input" id="entryPrice" required step="0.0001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prix Sortie</label>
                            <input type="number" class="form-input" id="exitPrice" step="0.0001">
                        </div>
                    </div>

                    <div class="form-grid form-grid-3">
                        <div class="form-group">
                            <label class="form-label">Quantit√©</label>
                            <input type="number" class="form-input" id="quantity" required step="0.001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Frais</label>
                            <input type="number" class="form-input" id="fees" value="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Taille Position (%)</label>
                            <input type="number" class="form-input" id="positionSize" step="0.1" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Strat√©gie</label>
                        <select class="form-input" id="strategy">
                            <option value="">Aucune strat√©gie</option>
                            <option value="swing">Swing Trading</option>
                            <option value="day">Day Trading</option>
                            <option value="scalp">Scalping</option>
                            <option value="momentum">Momentum</option>
                            <option value="mean_reversion">Mean Reversion</option>
                            <option value="breakout">Breakout</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Rating</label>
                        <div class="rating" id="tradeRating">
                            <span class="star" data-rating="1">‚òÖ</span>
                            <span class="star" data-rating="2">‚òÖ</span>
                            <span class="star" data-rating="3">‚òÖ</span>
                            <span class="star" data-rating="4">‚òÖ</span>
                            <span class="star" data-rating="5">‚òÖ</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Commentaire/Journal</label>
                        <textarea class="form-input" id="comment" rows="3" placeholder="Notes sur le trade, √©motions, apprentissages..."></textarea>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Date Entr√©e</label>
                            <input type="datetime-local" class="form-input" id="entryDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date Sortie</label>
                            <input type="datetime-local" class="form-input" id="exitDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-save"></i>
                            Enregistrer le Trade
                        </button>
                    </div>

                    <div id="editButtons" class="hidden">
                        <button type="button" class="btn btn-danger btn-block" onclick="deleteCurrentTrade()">
                            <i class="fas fa-trash"></i>
                            Supprimer le Trade
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyDGfiBOOEZiLZmh7clQlSZAr1W6P6Si8vM",
            authDomain: "journaltrading-a6bc6.firebaseapp.com",
            projectId: "journaltrading-a6bc6",
            storageBucket: "journaltrading-a6bc6.firebasestorage.app",
            messagingSenderId: "220303277331",
            appId: "1:220303277331:web:f4251eebd62d3058f82ee6",
            measurementId: "G-8EEHYVXQS6"
        };

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ========== √âTAT GLOBAL ==========
        const AppState = {
            trades: [],
            settings: {
                capital: 10000,
                currency: 'EUR',
                riskFreeRate: 2
            },
            currentUser: null,
            editingTrade: null,
            currentStrategyFilter: 'all',
            currentTradeTab: 'all',
            
            getStorageKey() {
                const userId = this.currentUser ? this.currentUser.uid : 'guest';
                return `mobile_trading_journal_${userId}`;
            },
            
            init() {
                this.loadFromLocal();
                this.loadSettings();
            },
            
            loadFromLocal() {
                try {
                    const storageKey = this.getStorageKey();
                    const storedTrades = localStorage.getItem(storageKey);
                    this.trades = storedTrades ? JSON.parse(storedTrades) : [];
                    this.trades = this.trades.filter(t => t && t.id && t.symbol);
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.trades = [];
                }
            },
            
            saveToLocal() {
                try {
                    const storageKey = this.getStorageKey();
                    localStorage.setItem(storageKey, JSON.stringify(this.trades));
                    return true;
                } catch (error) {
                    this.showToast('Erreur sauvegarde locale', 'error');
                    return false;
                }
            },
            
            loadSettings() {
                try {
                    const settings = localStorage.getItem('mobile_trading_settings');
                    if (settings) {
                        this.settings = { ...this.settings, ...JSON.parse(settings) };
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            },
            
            saveSettings() {
                try {
                    localStorage.setItem('mobile_trading_settings', JSON.stringify(this.settings));
                    return true;
                } catch (error) {
                    this.showToast('Erreur sauvegarde param√®tres', 'error');
                    return false;
                }
            },
            
            showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: 'üí°'
                };
                
                toast.innerHTML = `
                    <div>${icons[type] || icons.info}</div>
                    <div>${message}</div>
                `;
                
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 4000);
            }
        };

        // ========== AUTHENTIFICATION ==========
        async function signUp(email, password) {
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                return { success: true, user: userCredential.user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function signIn(email, password) {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                return { success: true, user: userCredential.user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const userCredential = await auth.signInWithPopup(provider);
                return { success: true, user: userCredential.user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function signInAnonymously() {
            try {
                const userCredential = await auth.signInAnonymously();
                return { success: true, user: userCredential.user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // ========== CALCULS AVANC√âS ==========
        function calculateSharpeRatio(trades, annualize = true) {
            const closedTrades = trades.filter(t => t.exitPrice && !isNaN(t.exitPrice));
            if (closedTrades.length < 2) return 0;
            
            const returns = closedTrades.map(t => t.pnlPercentage / 100);
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const volatility = Math.sqrt(returns.reduce((a, b) => a + Math.pow(b - avgReturn, 2), 0) / returns.length);
            
            const riskFreeRate = AppState.settings.riskFreeRate / 100;
            let sharpe = (avgReturn - riskFreeRate) / volatility;
            
            if (annualize) {
                sharpe = sharpe * Math.sqrt(252); // Annualisation
            }
            
            return parseFloat(sharpe.toFixed(2));
        }

        function calculateSortinoRatio(trades, annualize = true) {
            const closedTrades = trades.filter(t => t.exitPrice && !isNaN(t.exitPrice));
            if (closedTrades.length < 2) return 0;
            
            const returns = closedTrades.map(t => t.pnlPercentage / 100);
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            
            // Seulement les retours n√©gatifs pour le downside deviation
            const negativeReturns = returns.filter(r => r < 0);
            const downsideDeviation = Math.sqrt(negativeReturns.reduce((a, b) => a + Math.pow(b, 2), 0) / returns.length);
            
            const riskFreeRate = AppState.settings.riskFreeRate / 100;
            let sortino = (avgReturn - riskFreeRate) / downsideDeviation;
            
            if (annualize) {
                sortino = sortino * Math.sqrt(252);
            }
            
            return parseFloat(sortino.toFixed(2));
        }

        function calculateMaxDrawdown(trades) {
            const closedTrades = trades.filter(t => t.exitPrice && !isNaN(t.exitPrice));
            if (closedTrades.length === 0) return 0;
            
            let peak = 0;
            let maxDrawdown = 0;
            let runningTotal = 0;
            
            // Trier par date de sortie
            const sortedTrades = closedTrades.sort((a, b) => new Date(a.exitDate) - new Date(b.exitDate));
            
            sortedTrades.forEach(trade => {
                runningTotal += trade.pnl;
                if (runningTotal > peak) {
                    peak = runningTotal;
                }
                const drawdown = peak - runningTotal;
                if (drawdown > maxDrawdown) {
                    maxDrawdown = drawdown;
                }
            });
            
            const maxDrawdownPct = peak > 0 ? (maxDrawdown / peak) * 100 : 0;
            return parseFloat(maxDrawdownPct.toFixed(2));
        }

        function calculateVolatility(trades) {
            const closedTrades = trades.filter(t => t.exitPrice && !isNaN(t.exitPrice));
            if (closedTrades.length < 2) return 0;
            
            const returns = closedTrades.map(t => t.pnlPercentage / 100);
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const variance = returns.reduce((a, b) => a + Math.pow(b - avgReturn, 2), 0) / returns.length;
            const volatility = Math.sqrt(variance) * Math.sqrt(252); // Annualis√©e
            
            return parseFloat((volatility * 100).toFixed(2)); // En pourcentage
        }

        function calculatePositionSize(entryPrice, quantity) {
            const notional = entryPrice * quantity;
            const portfolioValue = AppState.settings.capital;
            return portfolioValue > 0 ? (notional / portfolioValue) * 100 : 0;
        }

        // ========== GESTION DES TRADES ==========
        function addTrade(tradeData) {
            const positionSize = calculatePositionSize(parseFloat(tradeData.entryPrice), parseFloat(tradeData.quantity));
            
            const trade = {
                id: generateId(),
                symbol: tradeData.symbol.toUpperCase(),
                side: tradeData.side,
                entryPrice: parseFloat(tradeData.entryPrice),
                exitPrice: tradeData.exitPrice ? parseFloat(tradeData.exitPrice) : null,
                quantity: parseFloat(tradeData.quantity),
                fees: parseFloat(tradeData.fees) || 0,
                strategy: tradeData.strategy || '',
                rating: tradeData.rating || 0,
                comment: tradeData.comment || '',
                entryDate: tradeData.entryDate || new Date().toISOString(),
                exitDate: tradeData.exitDate || null,
                positionSize: parseFloat(positionSize.toFixed(2)),
                pnl: 0,
                pnlPercentage: 0
            };

            // Calculer P&L
            if (trade.exitPrice) {
                let pnl;
                if (trade.side === 'long') {
                    pnl = (trade.exitPrice - trade.entryPrice) * trade.quantity;
                } else {
                    pnl = (trade.entryPrice - trade.exitPrice) * trade.quantity;
                }
                
                // Soustraire les frais
                pnl -= trade.fees;
                
                trade.pnl = parseFloat(pnl.toFixed(2));
                trade.pnlPercentage = parseFloat(((trade.pnl / (trade.entryPrice * trade.quantity)) * 100).toFixed(2));
            }

            AppState.trades.unshift(trade);
            
            if (AppState.saveToLocal()) {
                AppState.showToast('Trade ajout√© avec succ√®s', 'success');
                updateUI();
                closeTradeModal();
            }
        }

        function updateTrade(tradeId, tradeData) {
            const tradeIndex = AppState.trades.findIndex(t => t.id === tradeId);
            if (tradeIndex === -1) return;

            const positionSize = calculatePositionSize(parseFloat(tradeData.entryPrice), parseFloat(tradeData.quantity));

            const updatedTrade = {
                ...AppState.trades[tradeIndex],
                ...tradeData,
                entryPrice: parseFloat(tradeData.entryPrice),
                exitPrice: tradeData.exitPrice ? parseFloat(tradeData.exitPrice) : null,
                quantity: parseFloat(tradeData.quantity),
                fees: parseFloat(tradeData.fees) || 0,
                strategy: tradeData.strategy || '',
                rating: tradeData.rating || 0,
                comment: tradeData.comment || '',
                entryDate: tradeData.entryDate,
                exitDate: tradeData.exitDate,
                positionSize: parseFloat(positionSize.toFixed(2))
            };

            // Recalculer P&L
            if (updatedTrade.exitPrice) {
                let pnl;
                if (updatedTrade.side === 'long') {
                    pnl = (updatedTrade.exitPrice - updatedTrade.entryPrice) * updatedTrade.quantity;
                } else {
                    pnl = (updatedTrade.entryPrice - updatedTrade.exitPrice) * updatedTrade.quantity;
                }
                
                pnl -= updatedTrade.fees;
                
                updatedTrade.pnl = parseFloat(pnl.toFixed(2));
                updatedTrade.pnlPercentage = parseFloat(((updatedTrade.pnl / (updatedTrade.entryPrice * updatedTrade.quantity)) * 100).toFixed(2));
            } else {
                updatedTrade.pnl = 0;
                updatedTrade.pnlPercentage = 0;
            }

            AppState.trades[tradeIndex] = updatedTrade;
            
            if (AppState.saveToLocal()) {
                AppState.showToast('Trade modifi√© avec succ√®s', 'success');
                updateUI();
                closeTradeModal();
            }
        }

        function deleteTrade(tradeId) {
            AppState.trades = AppState.trades.filter(t => t.id !== tradeId);
            
            if (AppState.saveToLocal()) {
                AppState.showToast('Trade supprim√©', 'success');
                updateUI();
            }
        }

        // ========== IMPORT/EXPORT CSV ==========
        function exportCSV() {
            if (AppState.trades.length === 0) {
                AppState.showToast('Aucun trade √† exporter', 'warning');
                return;
            }

            const headers = ['ID', 'Symbol', 'Side', 'Entry Price', 'Exit Price', 'Quantity', 'Fees', 'P&L', 'P&L %', 'Position Size %', 'Strategy', 'Rating', 'Entry Date', 'Exit Date', 'Comment'];
            const csvData = [headers];

            AppState.trades.forEach(trade => {
                const row = [
                    trade.id,
                    trade.symbol,
                    trade.side,
                    trade.entryPrice,
                    trade.exitPrice || '',
                    trade.quantity,
                    trade.fees,
                    trade.pnl || '',
                    trade.pnlPercentage || '',
                    trade.positionSize || '',
                    trade.strategy || '',
                    trade.rating || '',
                    trade.entryDate,
                    trade.exitDate || '',
                    `"${(trade.comment || '').replace(/"/g, '""')}"`
                ];
                csvData.push(row);
            });

            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `trades_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            AppState.showToast('CSV export√© avec succ√®s', 'success');
        }

        function importCSV(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n').filter(line => line.trim());
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    
                    console.log('Headers d√©tect√©s:', headers);
                    console.log('Premi√®re ligne de donn√©es:', lines[1]);
                    
                    const importedTrades = [];
                    let importCount = 0;
                    let errorCount = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        const values = parseCSVLine(lines[i]);
                        console.log(`Ligne ${i}:`, values);
                        
                        if (values.length < 3) {
                            errorCount++;
                            continue;
                        }
                        
                        try {
                            // R√©cup√©ration des valeurs avec mapping flexible
                            const symbol = (getValue(values, headers, ['symbol', 'symbole', 'pair']) || 'UNKNOWN').replace(/['"]/g, '').toUpperCase();
                            const side = (getValue(values, headers, ['side', 'type', 'position']) || 'long').toLowerCase();
                            const entryPrice = parseFloat(getValue(values, headers, ['entry_price', 'entryprice', 'entry', 'open']));
                            const exitPrice = parseFloat(getValue(values, headers, ['exit_price', 'exitprice', 'exit', 'close'])) || null;
                            const quantity = parseFloat(getValue(values, headers, ['size', 'quantity', 'qty', 'amount', 'volume']));
                            const fees = parseFloat(getValue(values, headers, ['fees', 'fee', 'commission'])) || 0;
                            const strategy = getValue(values, headers, ['strategy', 'strat']) || '';
                            const rating = parseInt(getValue(values, headers, ['rating', 'score'])) || 0;
                            const comment = (getValue(values, headers, ['comment', 'note', 'description', 'remarks']) || '').replace(/['"]/g, '');
                            const entryDate = parseDate(getValue(values, headers, ['entry_timestamp', 'entrydate', 'entry_time', 'open_date']));
                            const exitDate = parseDate(getValue(values, headers, ['exit_timestamp', 'exitdate', 'exit_time', 'close_date']));
                            
                            // Validation des donn√©es obligatoires
                            if (!symbol || symbol === 'UNKNOWN') {
                                console.warn('Symbole manquant √† la ligne', i+1);
                                errorCount++;
                                continue;
                            }
                            
                            if (isNaN(entryPrice) || entryPrice <= 0) {
                                console.warn('Prix d\'entr√©e invalide √† la ligne', i+1, entryPrice);
                                errorCount++;
                                continue;
                            }
                            
                            if (isNaN(quantity) || quantity <= 0) {
                                console.warn('Quantit√© invalide √† la ligne', i+1, quantity);
                                errorCount++;
                                continue;
                            }
                            
                            // Calcul de la taille de position
                            const positionSize = calculatePositionSize(entryPrice, quantity);
                            
                            // Cr√©ation du trade
                            const trade = {
                                id: generateId(),
                                symbol: symbol,
                                side: side,
                                entryPrice: entryPrice,
                                exitPrice: exitPrice,
                                quantity: quantity,
                                fees: fees,
                                strategy: strategy,
                                rating: rating,
                                comment: comment,
                                entryDate: entryDate,
                                exitDate: exitDate,
                                positionSize: parseFloat(positionSize.toFixed(2)),
                                pnl: 0,
                                pnlPercentage: 0
                            };
                            
                            // Calcul du P&L
                            if (trade.exitPrice && !isNaN(trade.exitPrice)) {
                                let pnl;
                                if (trade.side === 'long') {
                                    pnl = (trade.exitPrice - trade.entryPrice) * trade.quantity;
                                } else {
                                    pnl = (trade.entryPrice - trade.exitPrice) * trade.quantity;
                                }
                                
                                // Soustraire les frais
                                pnl -= trade.fees;
                                
                                trade.pnl = parseFloat(pnl.toFixed(2));
                                trade.pnlPercentage = parseFloat(((trade.pnl / (trade.entryPrice * trade.quantity)) * 100).toFixed(2));
                            }
                            
                            console.log('Trade cr√©√©:', trade);
                            importedTrades.push(trade);
                            importCount++;
                            
                        } catch (error) {
                            console.error('Erreur ligne', i+1, ':', error, values);
                            errorCount++;
                        }
                    }
                    
                    // Appliquer les imports
                    if (importedTrades.length > 0) {
                        AppState.trades = [...importedTrades, ...AppState.trades];
                        if (AppState.saveToLocal()) {
                            AppState.showToast(
                                `${importCount} trades import√©s avec succ√®s${errorCount > 0 ? ` (${errorCount} erreurs)` : ''}`, 
                                'success'
                            );
                            updateUI();
                        } else {
                            AppState.showToast('Erreur sauvegarde des donn√©es', 'error');
                        }
                    } else {
                        AppState.showToast(
                            `Aucun trade valide trouv√©. ${errorCount} erreurs.`, 
                            'warning'
                        );
                    }
                    
                } catch (error) {
                    console.error('Erreur import CSV:', error);
                    AppState.showToast('Erreur format CSV: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                AppState.showToast('Erreur lecture fichier', 'error');
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // Fonctions utilitaires pour l'import CSV
        function getValue(values, headers, possibleKeys) {
            for (const key of possibleKeys) {
                const index = headers.indexOf(key.toLowerCase());
                if (index !== -1 && values[index] !== undefined) {
                    return values[index].trim();
                }
            }
            return '';
        }

        function parseDate(dateString) {
            if (!dateString) return new Date().toISOString();
            
            // Essayer diff√©rents formats de date
            const formats = [
                () => new Date(dateString),
                () => new Date(dateString.replace(' ', 'T')),
                () => new Date(dateString + 'Z'),
                () => {
                    const isoMatch = dateString.match(/^(\d{4}-\d{2}-\d{2})[T ](\d{2}:\d{2}:\d{2}(?:\.\d+)?)/);
                    if (isoMatch) {
                        return new Date(isoMatch[1] + 'T' + isoMatch[2]);
                    }
                    return null;
                }
            ];
            
            for (const format of formats) {
                try {
                    const date = format();
                    if (date && !isNaN(date.getTime())) {
                        return date.toISOString();
                    }
                } catch (e) {
                    // Continuer avec le format suivant
                }
            }
            
            console.warn('Date non reconnue:', dateString, 'utilisation date actuelle');
            return new Date().toISOString();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function generateId() {
            return 't_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
        }

        // ========== UI FUNCTIONS ==========
        function updateUI() {
            updateStats();
            updateTradeLists();
            updateCharts();
            updateStrategyFilters();
            updateOpenPositions();
            updateStrategyPerformance();
        }

        function updateStats() {
            const trades = AppState.trades;
            const closedTrades = trades.filter(t => t.exitPrice && !isNaN(t.exitPrice));
            const openTrades = trades.filter(t => !t.exitPrice || isNaN(t.exitPrice));
            
            console.log('Total trades:', trades.length, 'Closed trades:', closedTrades.length, 'Open trades:', openTrades.length);
            
            // P&L Total
            const totalPnl = closedTrades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
            document.getElementById('totalPnl').textContent = formatCurrency(totalPnl);
            document.getElementById('totalPnl').className = `stat-value ${totalPnl >= 0 ? 'stat-positive' : 'stat-negative'}`;
            
            // Win Rate
            const winningTrades = closedTrades.filter(t => (t.pnl || 0) > 0).length;
            const winRate = closedTrades.length > 0 ? (winningTrades / closedTrades.length) * 100 : 0;
            document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
            
            // Total Trades
            document.getElementById('totalTrades').textContent = trades.length;
            
            // Sharpe Ratio
            const sharpeRatio = calculateSharpeRatio(trades);
            document.getElementById('sharpeRatio').textContent = sharpeRatio;
            document.getElementById('sharpeRatio').className = `stat-value ${sharpeRatio >= 1 ? 'stat-positive' : sharpeRatio >= 0 ? 'stat-warning' : 'stat-negative'}`;
            
            // Max Drawdown
            const maxDrawdown = calculateMaxDrawdown(trades);
            document.getElementById('maxDrawdown').textContent = maxDrawdown + '%';
            document.getElementById('maxDrawdown').className = `stat-value ${maxDrawdown <= 10 ? 'stat-positive' : maxDrawdown <= 20 ? 'stat-warning' : 'stat-negative'}`;
            
            // Profit Factor
            const profits = closedTrades.filter(t => (t.pnl || 0) > 0).reduce((sum, t) => sum + (t.pnl || 0), 0);
            const losses = Math.abs(closedTrades.filter(t => (t.pnl || 0) < 0).reduce((sum, t) => sum + (t.pnl || 0), 0));
            const profitFactor = losses > 0 ? (profits / losses) : profits > 0 ? '‚àû' : '0';
            document.getElementById('profitFactor').textContent = typeof profitFactor === 'number' ? profitFactor.toFixed(2) : profitFactor;
            
            // Analytics Stats
            document.getElementById('analyticsProfitFactor').textContent = typeof profitFactor === 'number' ? profitFactor.toFixed(2) : profitFactor;
            document.getElementById('analyticsMaxDrawdown').textContent = maxDrawdown + '%';
            document.getElementById('analyticsSharpe').textContent = sharpeRatio;
            
            const sortinoRatio = calculateSortinoRatio(trades);
            document.getElementById('analyticsSortino').textContent = sortinoRatio;
            
            // Meilleur/Pire Trade
            const bestTrade = closedTrades.length > 0 ? Math.max(...closedTrades.map(t => t.pnl || 0)) : 0;
            const worstTrade = closedTrades.length > 0 ? Math.min(...closedTrades.map(t => t.pnl || 0)) : 0;
            document.getElementById('analyticsBestTrade').textContent = formatCurrency(bestTrade);
            document.getElementById('analyticsWorstTrade').textContent = formatCurrency(worstTrade);
            
            console.log('Stats calcul√©es:', { totalPnl, winRate, sharpeRatio, maxDrawdown, profitFactor });
        }

        function updateOpenPositions() {
            const openTrades = AppState.trades.filter(t => !t.exitPrice || isNaN(t.exitPrice));
            const container = document.getElementById('openPositionsList');
            const card = document.getElementById('openPositionsCard');
            const countElement = document.getElementById('openPositionsCount');
            
            if (openTrades.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            countElement.textContent = `${openTrades.length} position${openTrades.length > 1 ? 's' : ''}`;
            
            container.innerHTML = openTrades.map(trade => {
                const entryDate = new Date(trade.entryDate);
                const currentValue = trade.entryPrice * trade.quantity;
                const unrealizedPnl = 0; // En attendant l'int√©gration des prix en temps r√©el
                
                return `
                    <div class="trade-item open" onclick="editTrade('${trade.id}')">
                        <div class="trade-main">
                            <div class="trade-symbol">${trade.symbol}</div>
                            <div class="trade-details">
                                ${trade.side.toUpperCase()} ‚Ä¢ ${formatNumber(trade.quantity)} @ ${formatNumber(trade.entryPrice)}
                            </div>
                            <div class="trade-meta">
                                ${entryDate.toLocaleDateString('fr-FR')} ‚Ä¢ ${trade.positionSize}% du portefeuille
                                ${trade.strategy ? ` ‚Ä¢ ${getStrategyName(trade.strategy)}` : ''}
                            </div>
                        </div>
                        <div class="trade-pnl neutral">
                            ${formatCurrency(currentValue)}
                            <br><small>En cours</small>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTradeLists() {
            updateTradeList('recentTradesList', AppState.trades.slice(0, 5));
            updateAllTradesList();
        }

        function updateAllTradesList() {
            let filteredTrades = AppState.trades;
            
            // Filtre par strat√©gie
            if (AppState.currentStrategyFilter !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.strategy === AppState.currentStrategyFilter);
            }
            
            // Filtre par statut (ouvert/ferm√©)
            if (AppState.currentTradeTab === 'open') {
                filteredTrades = filteredTrades.filter(t => !t.exitPrice || isNaN(t.exitPrice));
            } else if (AppState.currentTradeTab === 'closed') {
                filteredTrades = filteredTrades.filter(t => t.exitPrice && !isNaN(t.exitPrice));
            }
            
            updateTradeList('allTradesList', filteredTrades);
        }

        function updateTradeList(elementId, trades) {
            const container = document.getElementById(elementId);
            
            if (trades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <div>Aucun trade enregistr√©</div>
                        <button class="btn btn-primary mt-16" onclick="openTradeModal()">
                            Ajouter votre premier trade
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = trades.map(trade => {
                const entryDate = new Date(trade.entryDate);
                const isClosed = trade.exitPrice && !isNaN(trade.exitPrice);
                
                let pnlDisplay, pnlClass, tradeClass;
                
                if (isClosed) {
                    pnlDisplay = `${formatCurrency(trade.pnl)} (${trade.pnlPercentage >= 0 ? '+' : ''}${trade.pnlPercentage}%)`;
                    pnlClass = trade.pnl > 0 ? 'positive' : trade.pnl < 0 ? 'negative' : '';
                    tradeClass = trade.pnl > 0 ? 'win' : trade.pnl < 0 ? 'loss' : '';
                } else {
                    pnlDisplay = 'En cours';
                    pnlClass = 'neutral';
                    tradeClass = 'open';
                }
                
                return `
                    <div class="trade-item ${tradeClass}" onclick="editTrade('${trade.id}')">
                        <div class="trade-main">
                            <div class="trade-symbol">${trade.symbol}</div>
                            <div class="trade-details">
                                ${trade.side.toUpperCase()} ‚Ä¢ ${formatNumber(trade.quantity)} @ ${formatNumber(trade.entryPrice)}
                                ${isClosed ? ` ‚Üí ${formatNumber(trade.exitPrice)}` : ''}
                            </div>
                            <div class="trade-meta">
                                ${entryDate.toLocaleDateString('fr-FR')}
                                ${trade.strategy ? ` ‚Ä¢ ${getStrategyName(trade.strategy)}` : ''}
                                ${trade.rating ? ` ‚Ä¢ ${'‚òÖ'.repeat(trade.rating)}` : ''}
                            </div>
                        </div>
                        <div class="trade-pnl ${pnlClass}">
                            ${pnlDisplay}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStrategyFilters() {
            const strategies = [...new Set(AppState.trades.map(t => t.strategy).filter(s => s))];
            const container = document.getElementById('strategyFilters');
            
            if (strategies.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div class="strategy-tag ${AppState.currentStrategyFilter === 'all' ? 'active' : ''}" 
                     onclick="setStrategyFilter('all')">Toutes</div>
                ${strategies.map(strategy => `
                    <div class="strategy-tag ${AppState.currentStrategyFilter === strategy ? 'active' : ''}" 
                         onclick="setStrategyFilter('${strategy}')">
                        ${getStrategyName(strategy)}
                    </div>
                `).join('')}
            `;
        }

        function updateStrategyPerformance() {
            const strategies = {};
            AppState.trades.forEach(trade => {
                if (trade.strategy && trade.exitPrice) {
                    if (!strategies[trade.strategy]) {
                        strategies[trade.strategy] = { trades: [], totalPnl: 0, winRate: 0 };
                    }
                    strategies[trade.strategy].trades.push(trade);
                    strategies[trade.strategy].totalPnl += trade.pnl || 0;
                }
            });
            
            // Calcul du win rate par strat√©gie
            Object.keys(strategies).forEach(strategy => {
                const stratData = strategies[strategy];
                const winningTrades = stratData.trades.filter(t => (t.pnl || 0) > 0).length;
                stratData.winRate = stratData.trades.length > 0 ? (winningTrades / stratData.trades.length) * 100 : 0;
            });
            
            const container = document.getElementById('strategyPerformanceList');
            const card = document.getElementById('strategyPerformanceCard');
            
            if (Object.keys(strategies).length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            
            container.innerHTML = Object.keys(strategies).map(strategy => {
                const stratData = strategies[strategy];
                const pnlClass = stratData.totalPnl >= 0 ? 'positive' : 'negative';
                
                return `
                    <div class="trade-item">
                        <div class="trade-main">
                            <div class="trade-symbol">${getStrategyName(strategy)}</div>
                            <div class="trade-details">
                                ${stratData.trades.length} trades ‚Ä¢ Win Rate: ${stratData.winRate.toFixed(1)}%
                            </div>
                        </div>
                        <div class="trade-pnl ${pnlClass}">
                            ${formatCurrency(stratData.totalPnl)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStrategyName(strategyKey) {
            const strategyNames = {
                'swing': 'Swing Trading',
                'day': 'Day Trading',
                'scalp': 'Scalping',
                'momentum': 'Momentum',
                'mean_reversion': 'Mean Reversion',
                'breakout': 'Breakout'
            };
            return strategyNames[strategyKey] || strategyKey;
        }

        function setStrategyFilter(strategy) {
            AppState.currentStrategyFilter = strategy;
            updateAllTradesList();
            updateStrategyFilters();
        }

        function setTradeTab(tab) {
            AppState.currentTradeTab = tab;
            document.querySelectorAll('#tradesPage .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#tradesPage .tab[data-tab="${tab}"]`).classList.add('active');
            updateAllTradesList();
        }

        function updateCharts() {
            updatePerformanceChart();
            updateAnalyticsChart();
            updateDistributionChart();
        }

        function updatePerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const closedTrades = AppState.trades.filter(t => t.exitPrice && !isNaN(t.exitPrice));
            
            if (closedTrades.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }
            
            // Donn√©es cumulatives avec drawdown
            let cumulative = 0;
            let peak = 0;
            const data = closedTrades
                .sort((a, b) => new Date(a.exitDate) - new Date(b.exitDate))
                .map(trade => {
                    cumulative += trade.pnl;
                    if (cumulative > peak) peak = cumulative;
                    const drawdown = peak - cumulative;
                    
                    return {
                        x: new Date(trade.exitDate),
                        y: cumulative,
                        drawdown: drawdown
                    };
                });
            
            // Destroy existing chart if it exists
            if (window.performanceChartInstance) {
                window.performanceChartInstance.destroy();
            }
            
            window.performanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'P&L Cumulatif',
                        data: data,
                        borderColor: '#00C48C',
                        backgroundColor: 'rgba(0, 196, 140, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `P&L: ${formatCurrency(context.parsed.y)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateAnalyticsChart() {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            const closedTrades = AppState.trades.filter(t => t.exitPrice && !isNaN(t.exitPrice));
            
            if (closedTrades.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }
            
            // Performance par symbole
            const symbolData = {};
            closedTrades.forEach(trade => {
                symbolData[trade.symbol] = (symbolData[trade.symbol] || 0) + trade.pnl;
            });
            
            const symbols = Object.keys(symbolData).slice(0, 8);
            const pnlData = symbols.map(symbol => symbolData[symbol]);
            
            // Destroy existing chart if it exists
            if (window.analyticsChartInstance) {
                window.analyticsChartInstance.destroy();
            }
            
            window.analyticsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: symbols,
                    datasets: [{
                        label: 'P&L par Symbole',
                        data: pnlData,
                        backgroundColor: pnlData.map(value => value >= 0 ? '#00C48C' : '#FF5C63')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            const closedTrades = AppState.trades.filter(t => t.exitPrice && !isNaN(t.exitPrice));
            
            if (closedTrades.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }
            
            // Distribution des P&L
            const pnlValues = closedTrades.map(t => t.pnl);
            const minPnl = Math.min(...pnlValues);
            const maxPnl = Math.max(...pnlValues);
            const range = maxPnl - minPnl;
            const binCount = Math.min(10, Math.ceil(Math.sqrt(closedTrades.length)));
            const binSize = range / binCount;
            
            const bins = Array(binCount).fill(0);
            pnlValues.forEach(pnl => {
                const binIndex = Math.min(binCount - 1, Math.floor((pnl - minPnl) / binSize));
                bins[binIndex]++;
            });
            
            const labels = bins.map((_, i) => {
                const start = minPnl + (i * binSize);
                const end = minPnl + ((i + 1) * binSize);
                return `${formatCurrency(start)} - ${formatCurrency(end)}`;
            });
            
            // Destroy existing chart if it exists
            if (window.distributionChartInstance) {
                window.distributionChartInstance.destroy();
            }
            
            window.distributionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre de Trades',
                        data: bins,
                        backgroundColor: '#2196F3'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // ========== MODAL FUNCTIONS ==========
        function openTradeModal(trade = null) {
            AppState.editingTrade = trade;
            const modal = document.getElementById('tradeModal');
            const form = document.getElementById('tradeForm');
            const modalTitle = document.getElementById('tradeModalTitle');
            const editButtons = document.getElementById('editButtons');
            
            modalTitle.textContent = trade ? 'Modifier le Trade' : 'Nouveau Trade';
            editButtons.classList.toggle('hidden', !trade);
            
            // Calcul automatique de la taille de position
            const updatePositionSize = () => {
                const entryPrice = parseFloat(document.getElementById('entryPrice').value) || 0;
                const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                const positionSize = calculatePositionSize(entryPrice, quantity);
                document.getElementById('positionSize').value = positionSize.toFixed(2);
            };
            
            document.getElementById('entryPrice').addEventListener('input', updatePositionSize);
            document.getElementById('quantity').addEventListener('input', updatePositionSize);
            
            if (trade) {
                document.getElementById('symbol').value = trade.symbol;
                document.getElementById('side').value = trade.side;
                document.getElementById('entryPrice').value = trade.entryPrice;
                document.getElementById('exitPrice').value = trade.exitPrice || '';
                document.getElementById('quantity').value = trade.quantity;
                document.getElementById('fees').value = trade.fees;
                document.getElementById('strategy').value = trade.strategy || '';
                document.getElementById('comment').value = trade.comment || '';
                document.getElementById('entryDate').value = trade.entryDate.slice(0, 16);
                document.getElementById('exitDate').value = trade.exitDate ? trade.exitDate.slice(0, 16) : '';
                
                // Rating stars
                document.querySelectorAll('#tradeRating .star').forEach((star, index) => {
                    star.classList.toggle('active', index < (trade.rating || 0));
                });
                
                updatePositionSize();
            } else {
                form.reset();
                document.getElementById('entryDate').value = new Date().toISOString().slice(0, 16);
                document.querySelectorAll('#tradeRating .star').forEach(star => {
                    star.classList.remove('active');
                });
                updatePositionSize();
            }
            
            // Rating stars interaction
            document.querySelectorAll('#tradeRating .star').forEach(star => {
                star.onclick = function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    document.querySelectorAll('#tradeRating .star').forEach((s, index) => {
                        s.classList.toggle('active', index < rating);
                    });
                };
            });
            
            modal.style.display = 'flex';
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').style.display = 'none';
            AppState.editingTrade = null;
        }

        function editTrade(tradeId) {
            const trade = AppState.trades.find(t => t.id === tradeId);
            if (trade) {
                openTradeModal(trade);
            }
        }

        function deleteCurrentTrade() {
            if (AppState.editingTrade) {
                if (confirm('Supprimer ce trade ?')) {
                    deleteTrade(AppState.editingTrade.id);
                    closeTradeModal();
                }
            }
        }

        // ========== PAGE NAVIGATION ==========
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const titles = {
                dashboardPage: 'Tableau de bord',
                tradesPage: 'Mes Trades',
                analyticsPage: 'Analytics',
                settingsPage: 'Param√®tres'
            };
            
            document.getElementById('headerTitle').textContent = titles[pageId] || 'Trade Journal';
            
            const navButtons = document.querySelectorAll('.nav-item');
            navButtons[0].classList.toggle('active', pageId === 'dashboardPage');
            navButtons[1].classList.toggle('active', pageId === 'tradesPage');
            navButtons[2].classList.toggle('active', pageId === 'analyticsPage');
            navButtons[3].classList.toggle('active', pageId === 'settingsPage');
        }

        // ========== SETTINGS ==========
        function saveSettings() {
            AppState.settings.capital = parseFloat(document.getElementById('initialCapital').value) || 10000;
            AppState.settings.currency = document.getElementById('currency').value;
            AppState.settings.riskFreeRate = parseFloat(document.getElementById('riskFreeRate').value) || 2;
            
            if (AppState.saveSettings()) {
                AppState.showToast('Param√®tres sauvegard√©s', 'success');
                updateUI();
            }
        }

        function loadSettingsToUI() {
            document.getElementById('initialCapital').value = AppState.settings.capital;
            document.getElementById('currency').value = AppState.settings.currency;
            document.getElementById('riskFreeRate').value = AppState.settings.riskFreeRate;
        }

        function clearAllData() {
            if (confirm('Supprimer TOUTES les donn√©es ? Cette action est irr√©versible.')) {
                AppState.trades = [];
                AppState.saveToLocal();
                updateUI();
                AppState.showToast('Toutes les donn√©es ont √©t√© supprim√©es', 'success');
            }
        }

        // ========== THEME MANAGEMENT ==========
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('mobile_trading_theme', newTheme);
            
            const icon = document.querySelector('#themeToggle i');
            icon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            
            AppState.showToast(`Th√®me ${newTheme === 'light' ? 'clair' : 'sombre'} activ√©`);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('mobile_trading_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const icon = document.querySelector('#themeToggle i');
            icon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '‚Ç¨0.00';
            
            const number = parseFloat(amount);
            const currency = AppState.settings.currency;
            const symbols = { EUR: '‚Ç¨', USD: '$', GBP: '¬£' };
            const symbol = symbols[currency] || '‚Ç¨';
            
            if (number >= 0) {
                return `${symbol}${Math.abs(number).toFixed(2)}`;
            } else {
                return `-${symbol}${Math.abs(number).toFixed(2)}`;
            }
        }

        function formatNumber(num) {
            if (!num && num !== 0) return '0';
            const number = parseFloat(num);
            
            if (number < 1) {
                return number.toFixed(6).replace(/\.?0+$/, '');
            } else if (number < 10) {
                return number.toFixed(4).replace(/\.?0+$/, '');
            } else if (number < 1000) {
                return number.toFixed(2).replace(/\.?0+$/, '');
            } else {
                return number.toFixed(0);
            }
        }

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', function() {
            AppState.init();
            loadTheme();
            
            // Gestion de l'authentification
            const authTabs = document.querySelectorAll('.auth-tab');
            const authForm = document.getElementById('authForm');
            const authEmail = document.getElementById('authEmail');
            const authPassword = document.getElementById('authPassword');
            const authConfirmGroup = document.getElementById('authConfirmGroup');
            const authConfirmPassword = document.getElementById('authConfirmPassword');
            const authSubmit = document.getElementById('authSubmit');
            
            let currentAuthTab = 'login';
            
            authTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    currentAuthTab = this.dataset.tab;
                    
                    authTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    authConfirmGroup.style.display = currentAuthTab === 'signup' ? 'block' : 'none';
                    authSubmit.textContent = currentAuthTab === 'signup' ? 'Cr√©er un compte' : 'Se connecter';
                });
            });
            
            authForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = authEmail.value;
                const password = authPassword.value;
                const confirmPassword = authConfirmPassword.value;
                
                if (currentAuthTab === 'signup' && password !== confirmPassword) {
                    AppState.showToast('Les mots de passe ne correspondent pas', 'error');
                    return;
                }
                
                authSubmit.disabled = true;
                authSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';
                
                let result;
                if (currentAuthTab === 'signup') {
                    result = await signUp(email, password);
                } else {
                    result = await signIn(email, password);
                }
                
                if (result.success) {
                    AppState.showToast(`Bienvenue ${result.user.email || 'Utilisateur'} !`, 'success');
                    initializeApp(result.user);
                } else {
                    AppState.showToast(result.error, 'error');
                }
                
                authSubmit.disabled = false;
                authSubmit.innerHTML = currentAuthTab === 'signup' ? 'Cr√©er un compte' : 'Se connecter';
            });
            
            document.getElementById('googleLogin').addEventListener('click', async function() {
                const result = await signInWithGoogle();
                if (result.success) {
                    AppState.showToast('Connexion Google r√©ussie', 'success');
                    initializeApp(result.user);
                } else {
                    AppState.showToast(result.error, 'error');
                }
            });
            
            document.getElementById('anonymousLogin').addEventListener('click', async function() {
                const result = await signInAnonymously();
                if (result.success) {
                    AppState.showToast('Mode invit√© activ√©', 'success');
                    initializeApp(result.user);
                } else {
                    AppState.showToast(result.error, 'error');
                }
            });
            
            // Gestion du formulaire de trade
            document.getElementById('tradeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const rating = document.querySelectorAll('#tradeRating .star.active').length;
                
                const formData = {
                    symbol: document.getElementById('symbol').value,
                    side: document.getElementById('side').value,
                    entryPrice: document.getElementById('entryPrice').value,
                    exitPrice: document.getElementById('exitPrice').value,
                    quantity: document.getElementById('quantity').value,
                    fees: document.getElementById('fees').value,
                    strategy: document.getElementById('strategy').value,
                    rating: rating,
                    comment: document.getElementById('comment').value,
                    entryDate: document.getElementById('entryDate').value,
                    exitDate: document.getElementById('exitDate').value
                };
                
                if (AppState.editingTrade) {
                    updateTrade(AppState.editingTrade.id, formData);
                } else {
                    addTrade(formData);
                }
            });
            
            // Boutons d'interface
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('logoutButton').addEventListener('click', signOut);
            
            // Gestion de l'import CSV
            document.getElementById('importFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    importCSV(file);
                }
                this.value = '';
            });
            
            // Tabs des trades
            document.querySelectorAll('#tradesPage .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    setTradeTab(this.getAttribute('data-tab'));
                });
            });
            
            // Fermer les modales en cliquant √† l'ext√©rieur
            document.getElementById('tradeModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTradeModal();
                }
            });
            
            // Observer les changements d'authentification
            auth.onAuthStateChanged(user => {
                if (user) {
                    initializeApp(user);
                } else {
                    showLoginScreen();
                }
            });
        });

        function initializeApp(user) {
            AppState.currentUser = user;
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appHeader').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('bottomNav').style.display = 'flex';
            document.getElementById('fabButton').style.display = 'flex';
            
            document.getElementById('userName').textContent = user.displayName || user.email || 'Utilisateur';
            document.getElementById('userEmail').textContent = user.email || 'Mode invit√©';
            document.getElementById('userAvatar').textContent = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
            
            AppState.loadFromLocal();
            loadSettingsToUI();
            updateUI();
            
            AppState.showToast(`Bienvenue ${user.email || 'Utilisateur'} !`);
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appHeader').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('bottomNav').style.display = 'none';
            document.getElementById('fabButton').style.display = 'none';
            
            AppState.currentUser = null;
        }

        async function signOut() {
            try {
                await auth.signOut();
                AppState.showToast('D√©connexion r√©ussie');
            } catch (error) {
                AppState.showToast('Erreur de d√©connexion', 'error');
            }
        }

        // Gestion des gestes tactiles pour la navigation
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const swipeDistance = touchEndX - touchStartX;
            
            if (Math.abs(swipeDistance) < swipeThreshold) return;
            
            const pages = ['dashboardPage', 'tradesPage', 'analyticsPage', 'settingsPage'];
            const currentPage = document.querySelector('.page.active').id;
            const currentIndex = pages.indexOf(currentPage);
            
            if (swipeDistance > 0 && currentIndex > 0) {
                showPage(pages[currentIndex - 1]);
            } else if (swipeDistance < 0 && currentIndex < pages.length - 1) {
                showPage(pages[currentIndex + 1]);
            }
        }

        // Fonction de debug
        function debugTrades() {
            console.log('=== DEBUG TRADES ===');
            AppState.trades.forEach((trade, index) => {
                console.log(`Trade ${index}:`, {
                    symbol: trade.symbol,
                    entry: trade.entryPrice,
                    exit: trade.exitPrice,
                    quantity: trade.quantity,
                    pnl: trade.pnl,
                    pnlPercentage: trade.pnlPercentage,
                    side: trade.side,
                    strategy: trade.strategy,
                    rating: trade.rating,
                    positionSize: trade.positionSize
                });
            });
            console.log('=== FIN DEBUG ===');
        }

        // Exposer les fonctions globales
        window.showPage = showPage;
        window.openTradeModal = openTradeModal;
        window.closeTradeModal = closeTradeModal;
        window.exportCSV = exportCSV;
        window.clearAllData = clearAllData;
        window.saveSettings = saveSettings;
        window.setStrategyFilter = setStrategyFilter;
        window.setTradeTab = setTradeTab;
        window.debugTrades = debugTrades;
    </script>
</body>
</html>
